<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>FEE DODGE</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body { width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', 'Courier New', monospace; }
  canvas { display: block; }
  #death-screen {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.94);
    flex-direction: column; align-items: center; justify-content: center;
    z-index: 10; color: #fff; gap: 16px;
  }
  #death-screen.visible { display: flex; }
  #death-screen h1 { font-size: 14px; letter-spacing: 6px; text-transform: uppercase; color: #555; margin-bottom: 8px; }
  #death-screen .stat { font-size: 48px; font-weight: 200; color: #fff; line-height: 1.1; }
  #death-screen .stat em { font-style: normal; color: #ff3b3b; }
  #death-screen .sub { font-size: 13px; color: #666; margin-top: 4px; max-width: 400px; text-align: center; line-height: 1.5; }
  #death-screen .fees-list { margin-top: 20px; font-size: 12px; color: #444; text-align: left; line-height: 1.8; }
  #death-screen .fees-list span { color: #ff3b3b; }
  #death-screen button {
    margin-top: 28px; padding: 12px 32px;
    background: transparent; border: 1px solid #333;
    color: #888; font-family: inherit; font-size: 12px;
    letter-spacing: 3px; text-transform: uppercase;
    cursor: pointer; transition: all 0.2s;
  }
  #death-screen button:hover { border-color: #fff; color: #fff; }
  #start-screen {
    position: fixed; inset: 0; background: #000;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    z-index: 20; color: #fff; gap: 12px; cursor: pointer;
    overflow: hidden;
  }
  #start-screen.hidden { display: none; }
  #start-canvas { position: absolute; inset: 0; z-index: 0; }
  #start-screen .start-content { position: relative; z-index: 1; display: flex; flex-direction: column; align-items: center; gap: 12px; pointer-events: none; }
  #start-screen .legend-mark { margin-bottom: 32px; opacity: 0.7; transition: opacity 0.3s; }
  #start-screen .legend-mark svg { width: 36px; height: 36px; }
  #start-screen h1 { font-size: 11px; letter-spacing: 8px; text-transform: uppercase; color: #555; margin-top: 4px; }
  #start-screen .title { font-size: 56px; font-weight: 200; letter-spacing: -1px; margin-top: 4px; }
  #start-screen .prompt { font-size: 12px; color: #666; margin-top: 32px; letter-spacing: 3px; animation: breathe 3.5s ease-in-out infinite; }
  @keyframes breathe { 0%,100%{opacity:0.25} 50%{opacity:0.85} }
  #death-screen .legend-footer { display: flex; flex-direction: column; align-items: center; gap: 12px; margin-top: 28px; }
  #death-screen .legend-footer .legend-wordmark { opacity: 0.5; }
  #death-screen .legend-footer .legend-wordmark svg { height: 18px; width: auto; }
  #death-screen .cta-text { font-size: 11px; letter-spacing: 3px; text-transform: uppercase; color: #555; margin-top: 4px; }
  #death-screen .app-store-link { display: inline-block; margin-top: 4px; transition: opacity 0.2s; }
  #death-screen .app-store-link:hover { opacity: 0.8; }
  #death-screen .app-store-link img { height: 44px; width: auto; border-radius: 8px; }
</style>
</head>
<body>

<div id="start-screen">
  <canvas id="start-canvas"></canvas>
  <div class="start-content">
    <div class="legend-mark">
      <svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M19.969 40C26.4698 40 32.2169 36.9516 35.8639 32.1751C35.9905 32.0093 36.0538 31.9264 36.0807 31.8257C36.1033 31.7409 36.1034 31.639 36.0807 31.5542C36.0539 31.4535 35.9906 31.3706 35.864 31.2047C32.217 26.4263 26.4708 23.3488 20 23.3488C13.5291 23.3488 7.78301 26.4263 4.13599 31.2047C4.00941 31.3706 3.94612 31.4535 3.91924 31.5542C3.89663 31.639 3.89664 31.7409 3.91927 31.8257C3.94616 31.9264 4.00946 32.0093 4.13604 32.1751C7.78303 36.9516 13.5282 40 19.969 40ZM19.969 0C8.94735 0 0 8.96124 0 20C0 23.5331 0.905963 26.8187 2.51107 29.7015C2.6087 29.8769 2.65752 29.9646 2.72878 30.001C2.7901 30.0323 2.86454 30.0382 2.93002 30.0168C3.00611 29.9921 3.06935 29.9115 3.19583 29.7503L19.3376 9.18504C19.5635 8.89719 19.6765 8.75326 19.8135 8.70134C19.9337 8.65582 20.0663 8.65582 20.1864 8.70134C20.3235 8.75326 20.4365 8.89719 20.6624 9.18504L36.8042 29.7503C36.9307 29.9115 36.9939 29.9921 37.07 30.0168C37.1355 30.0382 37.2099 30.0323 37.2712 30.001C37.3425 29.9646 37.3913 29.8769 37.4889 29.7015C39.094 26.8187 40 23.5331 40 20C40 8.96124 31.0526 0 19.969 0Z" fill="white"/>
      </svg>
    </div>
    <h1>Legend presents</h1>
    <div class="title">Fee Dodge</div>
    <div class="prompt">TAP OR CLICK TO START</div>
  </div>
</div>

<canvas id="game"></canvas>

<div id="death-screen">
  <h1>Game Over</h1>
  <div class="stat">You survived <em id="ds-years">0</em> years</div>
  <div class="stat" style="font-size:28px; margin-top:8px;">Lost <em id="ds-total">$0</em> to fees</div>
  <div class="fees-list" id="ds-fees"></div>
  <div class="sub">The average American pays $138,000+ in banking fees over a lifetime. On Legend: $0.</div>
  <button id="retry-btn">Try Again</button>
  <div class="legend-footer">
    <div class="legend-wordmark">
      <svg viewBox="0 0 160 28" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M45.71 6.7892H42.4141V21.2095H56.4875V18.4622H45.71V6.7892Z" fill="white"/>
        <path d="M62.926 12.6059V9.53645H75.0318V6.7892H59.6301V21.2095H75.0318V18.4622H62.926V15.3532H74.6549V12.6059H62.926Z" fill="white"/>
        <path d="M87.6321 6.63092C84.2643 6.63092 81.7913 7.26663 80.1569 8.50429C78.513 9.74922 77.746 11.581 77.746 13.9004V14.0983C77.746 16.4084 78.5234 18.239 80.138 19.4859C81.7444 20.7263 84.1523 21.3677 87.3722 21.3677H88.052C90.8491 21.3677 93.6298 20.9681 96.3584 20.382V12.6059H87.1439V15.3532H93.3425V18.081C91.7529 18.3992 90.0187 18.6205 88.212 18.6205H87.5122C85.2915 18.6205 83.7202 18.1978 82.7075 17.4321C81.7043 16.6736 81.2219 15.5573 81.2219 14.0983V13.9004C81.2219 12.4393 81.6857 11.3243 82.6921 10.5668C83.7091 9.8015 85.3097 9.37817 87.6321 9.37817H88.332C90.9901 9.37817 93.8204 9.89938 96.3584 10.6487V7.76329C93.8132 7.07277 90.9766 6.63092 88.332 6.63092H87.6321Z" fill="white"/>
        <path d="M103.337 12.6059V9.53645H115.443V6.7892H100.041V21.2095H115.443V18.4622H103.337V15.3532H115.066V12.6059H103.337Z" fill="white"/>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M156.329 8.73305C154.962 7.48303 152.864 6.7892 149.938 6.7892H140.312V21.2095H149.938C152.895 21.2095 154.993 20.5005 156.353 19.2374C157.714 17.9724 158.304 16.1798 158.304 14.0785V13.8806C158.304 11.7683 157.699 9.98539 156.329 8.73305ZM143.608 9.53645V18.4622H149.878C151.72 18.4622 152.944 18.0234 153.707 17.2769C154.471 16.531 154.809 15.4454 154.809 14.0785V13.8806C154.809 12.5341 154.471 11.4584 153.708 10.7172C152.944 9.97525 151.72 9.53645 149.878 9.53645H143.608Z" fill="white"/>
        <path d="M122.24 6.7892H118.637V21.2095H121.873V10.7169L132.926 21.2095H136.529V6.7892H133.293V17.2818L122.24 6.7892Z" fill="white"/>
        <path d="M14.3693 28C19.0399 28 23.1698 25.8727 25.7948 22.5381C25.8899 22.4172 25.9375 22.3568 25.9577 22.2828C25.9747 22.2206 25.9747 22.1453 25.9577 22.0831C25.9375 22.0091 25.8899 21.9486 25.7948 21.8277C23.1699 18.4917 19.0407 16.3442 14.3916 16.3442C9.74252 16.3442 5.6133 18.4917 2.98838 21.8277C2.89327 21.9486 2.84571 22.0091 2.82548 22.0831C2.8085 22.1453 2.8085 22.2206 2.8255 22.2828C2.84575 22.3568 2.8933 22.4172 2.98841 22.5381C5.61332 25.8727 9.74178 28 14.3693 28ZM14.3693 0C6.43834 0 0 6.27286 0 14C0 16.4742 0.65246 18.775 1.80837 20.7936C1.87841 20.9159 1.91342 20.977 1.96411 21.0027C2.00774 21.0247 2.06057 21.0289 2.10713 21.014C2.16124 20.9968 2.20643 20.9408 2.29682 20.8287L13.92 6.42324C14.0814 6.22325 14.162 6.12325 14.2593 6.08699C14.3446 6.0552 14.4386 6.0552 14.5239 6.08699C14.6212 6.12325 14.7018 6.22325 14.8632 6.42323L26.4864 20.8287C26.5768 20.9408 26.622 20.9968 26.6761 21.014C26.7227 21.0289 26.7755 21.0247 26.8191 21.0027C26.8698 20.977 26.9048 20.9159 26.9748 20.7936C28.1308 18.775 28.7832 16.4742 28.7832 14C28.7832 6.27286 22.3449 0 14.3693 0Z" fill="white"/>
      </svg>
    </div>
    <div class="cta-text">Skip the fees. Get started today.</div>
    <a class="app-store-link" href="https://apps.apple.com/us/app/legend-xyz/id6504718187" target="_blank" rel="noopener noreferrer">
      <img src="https://legend.xyz/footer/cta-app-store@2x.webp" alt="Download on the App Store" />
    </a>
  </div>
</div>

<script>
// --- START SCREEN: Dark room / flashlight reveal ---
(function startScreenFX() {
  const sc = document.getElementById('start-canvas');
  const sctx = sc.getContext('2d');
  let sw, sh;
  function sResize() { sw = sc.width = window.innerWidth; sh = sc.height = window.innerHeight; }
  sResize();
  window.addEventListener('resize', sResize);

  const mouse = { x: -999, y: -999, active: false };
  const startEl = document.getElementById('start-screen');

  startEl.addEventListener('mousemove', (e) => { mouse.x = e.clientX; mouse.y = e.clientY; mouse.active = true; });
  startEl.addEventListener('touchmove', (e) => { mouse.x = e.touches[0].clientX; mouse.y = e.touches[0].clientY; mouse.active = true; }, { passive: true });
  startEl.addEventListener('touchstart', (e) => { mouse.x = e.touches[0].clientX; mouse.y = e.touches[0].clientY; mouse.active = true; }, { passive: true });

  const PREVIEW_FEES = [
    '$4.86 ATM Fee', '$26.77 Overdraft', '$13.95 Monthly Fee', '$35 Wire Fee',
    '$2.50 Paper Fee', '$5 Inactivity Fee', '3% Foreign Txn', '$12 Acct Analysis',
    '$15 Returned Item', '$25 Stop Payment', 'Fine Print Fee', '$10 Low Balance',
    '$7.50 Check Fee', '$30 Cashier Check', '$3 Statement Fee', '$8 ACH Return'
  ];

  const ghosts = [];
  for (let i = 0; i < 14; i++) {
    const label = PREVIEW_FEES[i % PREVIEW_FEES.length];
    ghosts.push({
      x: Math.random() * 2000 - 200,
      y: 60 + Math.random() * (sh - 120),
      w: 90 + label.length * 5,
      h: 26,
      vx: (Math.random() > 0.5 ? 1 : -1) * (0.15 + Math.random() * 0.35),
      vy: (Math.random() - 0.5) * 0.1,
      label,
    });
  }

  // grid lines
  const gridLines = [];
  for (let x = 0; x < 2000; x += 40) gridLines.push({ x1: x, y1: 0, x2: x, y2: 2000, vert: true });
  for (let y = 0; y < 2000; y += 40) gridLines.push({ x1: 0, y1: y, x2: 2000, y2: y, vert: false });

  let gridOff = 0;
  let frame = 0;
  let ambientAngle = 0;

  function sDraw() {
    if (startEl.classList.contains('hidden')) return;
    frame++;
    gridOff = (gridOff + 0.15) % 40;

    // ambient mouse for mobile / no-mouse
    if (!mouse.active) {
      ambientAngle += 0.003;
      mouse.x = sw / 2 + Math.cos(ambientAngle) * sw * 0.15;
      mouse.y = sh / 2 + Math.sin(ambientAngle * 0.7) * sh * 0.1;
    }

    sctx.fillStyle = '#000';
    sctx.fillRect(0, 0, sw, sh);

    const lightR = 220;

    // grid revealed by light
    sctx.save();
    for (const line of gridLines) {
      const lx = line.vert ? line.x1 : mouse.x;
      const ly = line.vert ? mouse.y : (line.y1 + gridOff) % sh;
      const actualX = line.vert ? line.x1 : 0;
      const actualY = line.vert ? 0 : (line.y1 + gridOff) % sh;

      if (line.vert) {
        const dist = Math.abs(line.x1 - mouse.x);
        if (dist > lightR) continue;
        const alpha = (1 - dist / lightR) * 0.06;
        sctx.strokeStyle = `rgba(120,255,180,${alpha})`;
        sctx.lineWidth = 0.5;
        sctx.beginPath();
        sctx.moveTo(line.x1, 0);
        sctx.lineTo(line.x1, sh);
        sctx.stroke();
      } else {
        const yPos = (line.y1 + gridOff) % sh;
        const dist = Math.abs(yPos - mouse.y);
        if (dist > lightR) continue;
        const alpha = (1 - dist / lightR) * 0.06;
        sctx.strokeStyle = `rgba(120,255,180,${alpha})`;
        sctx.lineWidth = 0.5;
        sctx.beginPath();
        sctx.moveTo(0, yPos);
        sctx.lineTo(sw, yPos);
        sctx.stroke();
      }
    }
    sctx.restore();

    // ghost fees revealed by light
    for (const g of ghosts) {
      g.x += g.vx;
      g.y += g.vy;
      if (g.x > sw + 100) g.x = -g.w - 20;
      if (g.x < -g.w - 100) g.x = sw + 20;
      if (g.y < 30 || g.y > sh - 30) g.vy *= -1;

      const cx = g.x + g.w / 2;
      const cy = g.y + g.h / 2;
      const dist = Math.sqrt((cx - mouse.x) ** 2 + (cy - mouse.y) ** 2);
      if (dist > lightR + 40) continue;

      const reveal = Math.max(0, 1 - dist / lightR);
      const alpha = reveal * 0.55;

      sctx.globalAlpha = alpha;
      sctx.fillStyle = `rgba(255,60,60,0.08)`;
      sctx.strokeStyle = `rgba(255,70,70,${alpha * 0.6})`;
      sctx.lineWidth = 1;
      sctx.beginPath();
      const r = 3;
      sctx.moveTo(g.x + r, g.y);
      sctx.lineTo(g.x + g.w - r, g.y); sctx.arcTo(g.x + g.w, g.y, g.x + g.w, g.y + r, r);
      sctx.lineTo(g.x + g.w, g.y + g.h - r); sctx.arcTo(g.x + g.w, g.y + g.h, g.x + g.w - r, g.y + g.h, r);
      sctx.lineTo(g.x + r, g.y + g.h); sctx.arcTo(g.x, g.y + g.h, g.x, g.y + g.h - r, r);
      sctx.lineTo(g.x, g.y + r); sctx.arcTo(g.x, g.y, g.x + r, g.y, r);
      sctx.closePath();
      sctx.fill();
      sctx.stroke();

      sctx.fillStyle = `rgba(255,70,70,${alpha})`;
      sctx.font = `bold ${sw < 500 ? 8 : 10}px monospace`;
      sctx.textAlign = 'center';
      sctx.textBaseline = 'middle';
      sctx.fillText(g.label, cx, cy);
      sctx.globalAlpha = 1;
    }

    // soft radial light at mouse
    const grd = sctx.createRadialGradient(mouse.x, mouse.y, 0, mouse.x, mouse.y, lightR);
    grd.addColorStop(0, 'rgba(120,255,180,0.04)');
    grd.addColorStop(0.4, 'rgba(120,255,180,0.015)');
    grd.addColorStop(1, 'rgba(120,255,180,0)');
    sctx.fillStyle = grd;
    sctx.fillRect(0, 0, sw, sh);

    // tiny player preview at mouse position
    if (mouse.active) {
      sctx.beginPath();
      sctx.arc(mouse.x, mouse.y, 6, 0, Math.PI * 2);
      sctx.fillStyle = 'rgba(120,255,180,0.15)';
      sctx.fill();
      sctx.beginPath();
      sctx.arc(mouse.x, mouse.y, 3, 0, Math.PI * 2);
      sctx.fillStyle = 'rgba(120,255,180,0.3)';
      sctx.fill();
    }

    requestAnimationFrame(sDraw);
  }
  requestAnimationFrame(sDraw);
})();
</script>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

// --- AUDIO ENGINE (Tron-style synth) ---
let audioCtx, masterGain, bassOsc, bassGain, droneOsc, droneGain;
let audioStarted = false;

function initAudio() {
  if (audioStarted) return;
  audioStarted = true;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  masterGain = audioCtx.createGain();
  masterGain.gain.value = 0.3;
  masterGain.connect(audioCtx.destination);

  // low drone
  droneOsc = audioCtx.createOscillator();
  droneGain = audioCtx.createGain();
  droneOsc.type = 'sine';
  droneOsc.frequency.value = 55;
  droneGain.gain.value = 0.06;
  droneOsc.connect(droneGain);
  droneGain.connect(masterGain);
  droneOsc.start();

  // bass pulse
  bassOsc = audioCtx.createOscillator();
  bassGain = audioCtx.createGain();
  bassOsc.type = 'triangle';
  bassOsc.frequency.value = 82.4;
  bassGain.gain.value = 0;
  bassOsc.connect(bassGain);
  bassGain.connect(masterGain);
  bassOsc.start();
}

function playHitSound(value) {
  if (!audioCtx) return;
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  const filter = audioCtx.createBiquadFilter();
  osc.type = 'sawtooth';
  osc.frequency.value = 120 + Math.min(value, 35) * 8;
  filter.type = 'lowpass';
  filter.frequency.value = 800;
  filter.Q.value = 8;
  gain.gain.value = 0.15;
  osc.connect(filter);
  filter.connect(gain);
  gain.connect(masterGain);
  osc.start();
  gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.25);
  osc.stop(audioCtx.currentTime + 0.3);
}

function playNearMissSound() {
  if (!audioCtx) return;
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = 'sine';
  osc.frequency.value = 1200;
  gain.gain.value = 0.04;
  osc.connect(gain);
  gain.connect(masterGain);
  osc.start();
  osc.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.08);
  gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
  osc.stop(audioCtx.currentTime + 0.12);
}

function playDeathSound() {
  if (!audioCtx) return;
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = 'sawtooth';
  osc.frequency.value = 200;
  gain.gain.value = 0.2;
  osc.connect(gain);
  gain.connect(masterGain);
  osc.start();
  osc.frequency.exponentialRampToValueAtTime(30, audioCtx.currentTime + 0.8);
  gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 1);
  osc.stop(audioCtx.currentTime + 1.1);
  if (droneGain) droneGain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.5);
}

function updateDrone(speed) {
  if (!droneOsc) return;
  droneOsc.frequency.value = 55 + speed * 8;
  droneGain.gain.value = Math.min(0.12, 0.04 + speed * 0.008);
}

function pulseBass() {
  if (!bassGain) return;
  bassGain.gain.cancelScheduledValues(audioCtx.currentTime);
  bassGain.gain.setValueAtTime(0.08, audioCtx.currentTime);
  bassGain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.3);
}

// --- GAME ---
let W, H;
function resize() { W = canvas.width = window.innerWidth; H = canvas.height = window.innerHeight; }
resize();
window.addEventListener('resize', resize);

const FEES = [
  { label: '$4.86 ATM Fee', value: 4.86, w: 105, h: 28, speed: 1, color: '#ff4444' },
  { label: '$26.77 Overdraft', value: 26.77, w: 135, h: 32, speed: 0.7, color: '#ff6633' },
  { label: '$13.95 Monthly Fee', value: 13.95, w: 145, h: 28, speed: 0.85, color: '#ff5544' },
  { label: '$35 Wire Fee', value: 35, w: 115, h: 30, speed: 0.6, color: '#ff3322' },
  { label: '$2.50 Paper Fee', value: 2.50, w: 120, h: 26, speed: 1.2, color: '#cc4444' },
  { label: '$5 Inactivity Fee', value: 5, w: 125, h: 26, speed: 1.1, color: '#dd5555' },
  { label: '3% Foreign Txn', value: 15, w: 125, h: 28, speed: 0.9, color: '#ee4433' },
  { label: '$12 Acct Analysis', value: 12, w: 135, h: 28, speed: 0.75, color: '#dd3333' },
  { label: '$15 Returned Item', value: 15, w: 135, h: 28, speed: 0.65, color: '#ff2222' },
  { label: '$25 Stop Payment', value: 25, w: 135, h: 30, speed: 0.55, color: '#ee3344' },
  { label: 'Fine Print Fee', value: 8, w: 115, h: 26, speed: 1.3, color: '#993333', stealth: true },
  { label: '$10 Low Balance', value: 10, w: 125, h: 28, speed: 0.95, color: '#cc3322' },
];

let player, obstacles, balance, distance, gameSpeed, frameCount, totalFeesHit, feesHitMap;
let gameState = 'start';
let shakeAmount = 0;
let flashAmount = 0;
let particles = [];
let trailPoints = [];
let nearMissTimer = 0;
let nearMissCount = 0;
let gridOffset = 0;
let dodgedCount = 0;

const playerTarget = { x: 0, y: 0 };

function initGame() {
  player = { x: W / 2, y: H * 0.78, radius: 14 };
  playerTarget.x = player.x;
  playerTarget.y = player.y;
  obstacles = [];
  particles = [];
  trailPoints = [];
  balance = 100;
  distance = 0;
  gameSpeed = 1.6;
  frameCount = 0;
  totalFeesHit = 0;
  feesHitMap = {};
  shakeAmount = 0;
  flashAmount = 0;
  nearMissTimer = 0;
  nearMissCount = 0;
  dodgedCount = 0;
  gameState = 'playing';
  initAudio();
}

function spawnObstacle() {
  const fee = FEES[Math.floor(Math.random() * FEES.length)];
  const side = Math.random() > 0.5;
  const scaledW = fee.w * (W < 500 ? 0.72 : 1);
  const ob = {
    x: side ? -scaledW - 10 : W + 10,
    y: 70 + Math.random() * (H * 0.68),
    w: scaledW,
    h: fee.h,
    vx: (side ? 1 : -1) * fee.speed * (0.8 + Math.random() * 0.4) * gameSpeed,
    vy: (Math.random() - 0.5) * 0.4 * gameSpeed,
    label: fee.label,
    value: fee.value,
    color: fee.color,
    stealth: fee.stealth || false,
    opacity: fee.stealth ? 0 : 1,
    hit: false,
    nearMissed: false,
    rotation: (Math.random() - 0.5) * 0.02,
    angle: 0,
    pulse: 0,
  };
  obstacles.push(ob);
}

function spawnParticles(x, y, color, count, spread) {
  const sp = spread || 6;
  for (let i = 0; i < count; i++) {
    const angle = Math.random() * Math.PI * 2;
    const vel = 1 + Math.random() * sp;
    particles.push({
      x, y,
      vx: Math.cos(angle) * vel,
      vy: Math.sin(angle) * vel,
      life: 1,
      color,
      size: 1.5 + Math.random() * 3,
    });
  }
}

function spawnSparks(x, y) {
  for (let i = 0; i < 6; i++) {
    const angle = Math.random() * Math.PI * 2;
    const vel = 3 + Math.random() * 5;
    particles.push({
      x, y,
      vx: Math.cos(angle) * vel,
      vy: Math.sin(angle) * vel,
      life: 1,
      color: '#78FFB4',
      size: 1 + Math.random() * 1.5,
      spark: true,
    });
  }
}

function handleInput(clientX, clientY) {
  playerTarget.x = clientX;
  playerTarget.y = clientY;
}

canvas.addEventListener('mousemove', (e) => { if (gameState === 'playing') handleInput(e.clientX, e.clientY); });
canvas.addEventListener('touchmove', (e) => {
  e.preventDefault();
  if (gameState === 'playing') handleInput(e.touches[0].clientX, e.touches[0].clientY);
}, { passive: false });
canvas.addEventListener('touchstart', (e) => {
  e.preventDefault();
  if (gameState === 'playing') handleInput(e.touches[0].clientX, e.touches[0].clientY);
}, { passive: false });

document.getElementById('start-screen').addEventListener('click', () => {
  document.getElementById('start-screen').classList.add('hidden');
  initGame();
});
document.getElementById('retry-btn').addEventListener('click', () => {
  document.getElementById('death-screen').classList.remove('visible');
  initGame();
});

function getYears() { return (distance / 800).toFixed(1); }

function update() {
  if (gameState !== 'playing') return;

  frameCount++;
  distance += gameSpeed;
  gameSpeed = 1.6 + distance * 0.00035;
  gridOffset = (gridOffset + gameSpeed * 0.3) % 40;

  updateDrone(gameSpeed);
  if (frameCount % 30 === 0) pulseBass();

  const spawnRate = Math.max(14, 48 - distance * 0.008);
  if (frameCount % Math.floor(spawnRate) === 0) spawnObstacle();

  const lerp = 0.13;
  player.x += (playerTarget.x - player.x) * lerp;
  player.y += (playerTarget.y - player.y) * lerp;
  player.x = Math.max(player.radius, Math.min(W - player.radius, player.x));
  player.y = Math.max(player.radius, Math.min(H - player.radius, player.y));

  trailPoints.unshift({ x: player.x, y: player.y, life: 1 });
  if (trailPoints.length > 28) trailPoints.pop();
  trailPoints.forEach(p => p.life -= 0.04);

  nearMissTimer = Math.max(0, nearMissTimer - 1);

  for (let i = obstacles.length - 1; i >= 0; i--) {
    const ob = obstacles[i];
    ob.x += ob.vx;
    ob.y += ob.vy;
    ob.angle += ob.rotation;
    ob.pulse = Math.max(0, ob.pulse - 0.03);

    if (ob.stealth) {
      const dx = player.x - (ob.x + ob.w / 2);
      const dy = player.y - (ob.y + ob.h / 2);
      const dist = Math.sqrt(dx * dx + dy * dy);
      ob.opacity = Math.max(0, Math.min(1, 1 - (dist - 60) / 100));
    }

    if (ob.x < -ob.w - 60 || ob.x > W + 60 || ob.y < -60 || ob.y > H + 60) {
      if (!ob.hit && !ob.nearMissed) dodgedCount++;
      obstacles.splice(i, 1);
      continue;
    }

    if (!ob.hit) {
      const closestX = Math.max(ob.x, Math.min(player.x, ob.x + ob.w));
      const closestY = Math.max(ob.y, Math.min(player.y, ob.y + ob.h));
      const dx = player.x - closestX;
      const dy = player.y - closestY;
      const distSq = dx * dx + dy * dy;

      // near miss detection
      if (!ob.nearMissed && distSq < (player.radius + 18) * (player.radius + 18) && distSq > player.radius * player.radius) {
        ob.nearMissed = true;
        nearMissTimer = 20;
        nearMissCount++;
        spawnSparks(closestX, closestY);
        playNearMissSound();
      }

      if (distSq < player.radius * player.radius) {
        ob.hit = true;
        balance -= ob.value;
        totalFeesHit += ob.value;
        feesHitMap[ob.label] = (feesHitMap[ob.label] || 0) + ob.value;
        shakeAmount = 10;
        flashAmount = 1;
        spawnParticles(player.x, player.y, ob.color, 18, 8);
        playHitSound(ob.value);

        if (balance <= 0) {
          balance = 0;
          gameState = 'dead';
          playDeathSound();
          showDeath();
        }
      }
    }
  }

  particles = particles.filter(p => {
    p.x += p.vx;
    p.y += p.vy;
    p.life -= p.spark ? 0.05 : 0.025;
    p.vx *= 0.95;
    p.vy *= p.spark ? 0.92 : 0.96;
    if (p.spark) p.vy += 0.1;
    return p.life > 0;
  });

  shakeAmount *= 0.82;
  flashAmount *= 0.85;
}

function roundRect(x, y, w, h, r) {
  if (ctx.roundRect) { ctx.roundRect(x, y, w, h, r); return; }
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + w - r, y); ctx.arcTo(x + w, y, x + w, y + r, r);
  ctx.lineTo(x + w, y + h - r); ctx.arcTo(x + w, y + h, x + w - r, y + h, r);
  ctx.lineTo(x + r, y + h); ctx.arcTo(x, y + h, x, y + h - r, r);
  ctx.lineTo(x, y + r); ctx.arcTo(x, y, x + r, y, r);
  ctx.closePath();
}

function draw() {
  if (!player) { ctx.fillStyle = '#000'; ctx.fillRect(0, 0, W, H); return; }
  ctx.save();
  if (shakeAmount > 0.5) {
    ctx.translate((Math.random() - 0.5) * shakeAmount * 2, (Math.random() - 0.5) * shakeAmount * 2);
  }

  // background
  ctx.fillStyle = '#000';
  ctx.fillRect(0, 0, W, H);

  // Tron grid (scrolling)
  const gridAlpha = 0.025 + gameSpeed * 0.003;
  ctx.strokeStyle = `rgba(120,255,180,${gridAlpha})`;
  ctx.lineWidth = 0.5;
  for (let x = 0; x < W; x += 40) { ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, H); ctx.stroke(); }
  for (let y = -40 + (gridOffset % 40); y < H + 40; y += 40) { ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke(); }

  // perspective horizon glow
  const horizGrd = ctx.createLinearGradient(0, H * 0.85, 0, H);
  horizGrd.addColorStop(0, 'rgba(120,255,180,0)');
  horizGrd.addColorStop(1, `rgba(120,255,180,${0.02 + gameSpeed * 0.003})`);
  ctx.fillStyle = horizGrd;
  ctx.fillRect(0, H * 0.85, W, H * 0.15);

  // flash on hit
  if (flashAmount > 0.05) {
    ctx.fillStyle = `rgba(255,50,50,${flashAmount * 0.08})`;
    ctx.fillRect(0, 0, W, H);
  }

  // trail (neon line)
  if (trailPoints.length > 1) {
    ctx.beginPath();
    ctx.moveTo(trailPoints[0].x, trailPoints[0].y);
    for (let i = 1; i < trailPoints.length; i++) {
      if (trailPoints[i].life <= 0) break;
      ctx.lineTo(trailPoints[i].x, trailPoints[i].y);
    }
    ctx.strokeStyle = 'rgba(120,255,180,0.3)';
    ctx.lineWidth = 3;
    ctx.lineCap = 'round';
    ctx.stroke();

    // inner bright line
    ctx.beginPath();
    ctx.moveTo(trailPoints[0].x, trailPoints[0].y);
    for (let i = 1; i < Math.min(8, trailPoints.length); i++) {
      if (trailPoints[i].life <= 0) break;
      ctx.lineTo(trailPoints[i].x, trailPoints[i].y);
    }
    ctx.strokeStyle = 'rgba(120,255,180,0.6)';
    ctx.lineWidth = 1.5;
    ctx.stroke();
  }

  // trail glow orbs
  for (let i = 0; i < trailPoints.length; i++) {
    const p = trailPoints[i];
    if (p.life <= 0) continue;
    ctx.beginPath();
    ctx.arc(p.x, p.y, player.radius * p.life * 0.4, 0, Math.PI * 2);
    ctx.fillStyle = `rgba(120,255,180,${p.life * 0.08})`;
    ctx.fill();
  }

  // player outer glow
  const outerGlow = ctx.createRadialGradient(player.x, player.y, 0, player.x, player.y, 60);
  outerGlow.addColorStop(0, 'rgba(120,255,180,0.12)');
  outerGlow.addColorStop(0.5, 'rgba(120,255,180,0.03)');
  outerGlow.addColorStop(1, 'rgba(120,255,180,0)');
  ctx.fillStyle = outerGlow;
  ctx.beginPath();
  ctx.arc(player.x, player.y, 60, 0, Math.PI * 2);
  ctx.fill();

  // player body
  ctx.beginPath();
  ctx.arc(player.x, player.y, player.radius, 0, Math.PI * 2);
  const bodyGrd = ctx.createRadialGradient(player.x - 3, player.y - 3, 0, player.x, player.y, player.radius);
  bodyGrd.addColorStop(0, '#aaffdd');
  bodyGrd.addColorStop(1, '#78FFB4');
  ctx.fillStyle = bodyGrd;
  ctx.fill();

  // player ring
  ctx.beginPath();
  ctx.arc(player.x, player.y, player.radius + 3, 0, Math.PI * 2);
  ctx.strokeStyle = nearMissTimer > 0 ? 'rgba(255,255,255,0.6)' : 'rgba(120,255,180,0.2)';
  ctx.lineWidth = nearMissTimer > 0 ? 2 : 1;
  ctx.stroke();

  // $ symbol
  ctx.fillStyle = '#000';
  ctx.font = `bold ${player.radius}px monospace`;
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText('$', player.x, player.y + 1);

  // obstacles
  obstacles.forEach(ob => {
    if (ob.hit) return;
    const a = ob.stealth ? ob.opacity : 1;
    if (a < 0.02) return;

    ctx.save();
    ctx.globalAlpha = a;
    ctx.translate(ob.x + ob.w / 2, ob.y + ob.h / 2);
    ctx.rotate(ob.angle);

    // obstacle glow
    const glowSize = 6 + ob.pulse * 10;
    ctx.shadowColor = ob.color;
    ctx.shadowBlur = glowSize;

    // body
    ctx.fillStyle = ob.color + '14';
    ctx.strokeStyle = ob.color + (ob.nearMissed ? 'cc' : '55');
    ctx.lineWidth = ob.nearMissed ? 1.5 : 1;
    ctx.beginPath();
    roundRect(-ob.w / 2, -ob.h / 2, ob.w, ob.h, 3);
    ctx.fill();
    ctx.stroke();

    ctx.shadowBlur = 0;

    // scan line effect
    const scanY = ((frameCount * 2 + ob.y) % ob.h) - ob.h / 2;
    ctx.fillStyle = ob.color + '08';
    ctx.fillRect(-ob.w / 2, scanY, ob.w, 2);

    // label
    ctx.fillStyle = ob.color;
    ctx.font = `bold ${W < 500 ? 9 : 11}px monospace`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(ob.label, 0, 0);

    ctx.restore();
  });

  // particles
  particles.forEach(p => {
    ctx.globalAlpha = p.life;
    if (p.spark) {
      ctx.fillStyle = '#fff';
      ctx.fillRect(p.x - 0.5, p.y - 0.5, p.size * p.life, 1);
    } else {
      ctx.fillStyle = p.color;
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.size * p.life, 0, Math.PI * 2);
      ctx.fill();
    }
    ctx.globalAlpha = 1;
  });

  // near miss indicator
  if (nearMissTimer > 0) {
    ctx.fillStyle = `rgba(120,255,180,${nearMissTimer / 20 * 0.5})`;
    ctx.font = 'bold 11px monospace';
    ctx.textAlign = 'center';
    ctx.fillText('CLOSE!', player.x, player.y - 28);
  }

  // HUD
  if (gameState === 'playing' || gameState === 'dead') {
    // balance
    ctx.fillStyle = '#444';
    ctx.font = '9px monospace';
    ctx.textAlign = 'left';
    ctx.fillText('BALANCE', 20, 28);
    ctx.fillStyle = balance > 50 ? '#78FFB4' : balance > 20 ? '#FFD666' : '#ff4444';
    ctx.font = 'bold 26px monospace';
    ctx.fillText('$' + balance.toFixed(2), 20, 54);

    // balance bar
    const barW = 120;
    const barH = 3;
    const barX = 20;
    const barY = 62;
    ctx.fillStyle = '#111';
    ctx.fillRect(barX, barY, barW, barH);
    ctx.fillStyle = balance > 50 ? '#78FFB4' : balance > 20 ? '#FFD666' : '#ff4444';
    ctx.fillRect(barX, barY, barW * (balance / 100), barH);

    // years
    ctx.fillStyle = '#444';
    ctx.font = '9px monospace';
    ctx.textAlign = 'right';
    ctx.fillText('YEARS SURVIVED', W - 20, 28);
    ctx.fillStyle = '#fff';
    ctx.font = 'bold 26px monospace';
    ctx.fillText(getYears(), W - 20, 54);

    // fees
    ctx.fillStyle = '#2a2a2a';
    ctx.font = '9px monospace';
    ctx.textAlign = 'center';
    ctx.fillText('FEES TAKEN', W / 2, 28);
    ctx.fillStyle = '#ff4444';
    ctx.font = 'bold 18px monospace';
    ctx.fillText('-$' + totalFeesHit.toFixed(2), W / 2, 50);

    // dodged counter
    if (dodgedCount > 0) {
      ctx.fillStyle = '#1a3a2a';
      ctx.font = '9px monospace';
      ctx.textAlign = 'center';
      ctx.fillText('DODGED', W / 2, 66);
      ctx.fillStyle = '#4a8a6a';
      ctx.font = 'bold 12px monospace';
      ctx.fillText(dodgedCount.toString(), W / 2, 80);
    }
  }

  ctx.restore();
}

function showDeath() {
  document.getElementById('ds-years').textContent = getYears();
  document.getElementById('ds-total').textContent = '$' + totalFeesHit.toFixed(2);
  const feesEl = document.getElementById('ds-fees');
  const sorted = Object.entries(feesHitMap).sort((a, b) => b[1] - a[1]);
  feesEl.innerHTML = sorted.slice(0, 6).map(([label, val]) =>
    `<span>-$${val.toFixed(2)}</span> ${label}`
  ).join('<br>');
  setTimeout(() => document.getElementById('death-screen').classList.add('visible'), 600);
}

function loop() { update(); draw(); requestAnimationFrame(loop); }
loop();
</script>
</body>
</html>
