<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>FEE DODGE</title>
<meta name="description" content="Can you dodge every bank fee? The average American loses $138,000+ to fees in a lifetime. On Legend: $0.">
<meta property="og:title" content="Fee Dodge — by Legend">
<meta property="og:description" content="I survived bank fees. Can you beat my score?">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary_large_image">
<style>
  @font-face { font-family: 'Knapp'; src: url('fonts/Knapp-Light.otf') format('opentype'); font-weight: 300; font-style: normal; font-display: swap; }
  @font-face { font-family: 'Knapp'; src: url('fonts/Knapp-Regular.otf') format('opentype'); font-weight: 400; font-style: normal; font-display: swap; }
  @font-face { font-family: 'Knapp'; src: url('fonts/Knapp-Medium.otf') format('opentype'); font-weight: 500; font-style: normal; font-display: swap; }
  @font-face { font-family: 'Mono'; src: url('fonts/PPNeueMontrealMono-Regular.otf') format('opentype'); font-weight: 400; font-style: normal; font-display: swap; }
  @font-face { font-family: 'Mono'; src: url('fonts/PPNeueMontrealMono-Medium.otf') format('opentype'); font-weight: 500; font-style: normal; font-display: swap; }
  @font-face { font-family: 'Mono'; src: url('fonts/PPNeueMontrealMono-Bold.otf') format('opentype'); font-weight: 700; font-style: normal; font-display: swap; }

  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body {
    width: 100%; height: 100%; overflow: hidden; background: #000;
    font-family: 'Knapp', -apple-system, sans-serif;
    -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
  }
  canvas { display: block; }

  /* ---- START SCREEN ---- */
  #start-screen {
    position: fixed; inset: 0; background: #000;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    z-index: 20; color: #fff; cursor: pointer; overflow: hidden;
    transition: opacity 0.5s ease-out;
  }
  #start-screen.hidden { opacity: 0; pointer-events: none; }
  #start-canvas { position: absolute; inset: 0; z-index: 0; }

  /* top bar */
  .top-bar {
    position: absolute; top: 28px; left: 0; right: 0; z-index: 2;
    display: flex; align-items: center; justify-content: center; gap: 10px;
  }
  .top-bar img { height: 22px; width: auto; }

  /* center content */
  .start-center {
    position: relative; z-index: 1; display: flex; flex-direction: column;
    align-items: center; pointer-events: none; margin-top: -60px;
  }
  .title-svg { width: clamp(340px, 54vw, 627px); height: auto; animation: titleBreath 4s ease-in-out infinite; }
  @keyframes titleBreath { 0%,100% { filter: brightness(0.85); } 50% { filter: brightness(1); } }

  .bg-illustration {
    position: absolute; z-index: 0; top: 50%; left: 50%;
    transform: translate(-50%, -38%); width: clamp(420px, 55vw, 575px); height: auto;
    pointer-events: none;
  }

  .challenge-intro { text-align: center; margin: 14px 0 0; }
  .challenge-intro .challenger { font-family: 'Mono', monospace; font-size: 11px; color: #555; letter-spacing: 4px; text-transform: uppercase; }
  .challenge-intro .challenge-score { font-family: 'Knapp'; font-size: 48px; font-weight: 300; color: #ff4444; margin: 4px 0; line-height: 1; }
  .challenge-intro .challenge-dare { font-family: 'Knapp'; font-size: 15px; color: #777; font-weight: 400; }

  /* corner icons */
  .corner-icon {
    position: absolute; bottom: 20px; z-index: 3; width: 48px; height: 48px;
    border-radius: 12px; display: flex; align-items: center; justify-content: center;
    cursor: pointer; pointer-events: auto; transition: all 0.35s ease;
    border: none; background: none; overflow: hidden;
  }
  .corner-icon .icon-img { width: 100%; height: 100%; border-radius: 12px; transition: all 0.35s ease; }
  .corner-icon.left { left: 20px; }
  .corner-icon.right { right: 20px; }
  .corner-icon.active .icon-img { filter: drop-shadow(0 0 8px rgba(120,255,180,0.5)); }
  .corner-icon:hover { transform: scale(1.1); }

  #legend-mode-toast {
    position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%);
    z-index: 25; font-family: 'Mono', monospace; font-size: 10px; letter-spacing: 4px;
    text-transform: uppercase; color: #78FFB4; opacity: 0;
    transition: opacity 0.5s; pointer-events: none;
    text-shadow: 0 0 20px rgba(120,255,180,0.3);
    background: rgba(0,0,0,0.85); padding: 10px 24px; border-radius: 6px;
    border: 1px solid rgba(120,255,180,0.15);
  }
  #legend-mode-toast.visible { opacity: 1; }

  /* ---- DEATH SCREEN ---- */
  #death-screen {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.97); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
    flex-direction: column; align-items: center; justify-content: center;
    z-index: 10; color: #fff; padding: 24px; overflow-y: auto;
  }
  #death-screen.visible { display: flex; }
  .death-inner { display: flex; flex-direction: column; align-items: center; max-width: 420px; width: 100%; }
  .death-inner > * { opacity: 0; transform: translateY(10px); animation: fsi 0.5s ease-out forwards; }
  @keyframes fsi { to { opacity: 1; transform: translateY(0); } }
  .death-inner .label-tag { font-family: 'Mono'; font-size: 10px; letter-spacing: 5px; text-transform: uppercase; color: #444; margin-bottom: 12px; animation-delay: 0s; }
  .death-inner .big-stat { font-family: 'Knapp'; font-size: clamp(40px, 10vw, 52px); font-weight: 300; color: #fff; line-height: 1; animation-delay: 0.08s; }
  .death-inner .big-stat em { font-style: normal; color: #ff3b3b; }
  .death-inner .sub-stat { font-family: 'Knapp'; font-size: 20px; font-weight: 300; color: #888; margin-top: 8px; animation-delay: 0.16s; }
  .death-inner .sub-stat em { font-style: normal; color: #ff3b3b; }
  .death-inner .fees-list { font-family: 'Mono'; margin-top: 18px; font-size: 11px; color: #333; text-align: left; line-height: 2; animation-delay: 0.24s; }
  .death-inner .fees-list span { color: #ff3b3b; font-weight: 700; }
  .death-inner .editorial { font-family: 'Knapp'; font-size: 13px; font-weight: 400; color: #3a3a3a; margin-top: 18px; text-align: center; line-height: 1.6; max-width: 360px; animation-delay: 0.32s; }
  .death-inner .actions-row { display: flex; gap: 10px; margin-top: 22px; flex-wrap: wrap; justify-content: center; animation-delay: 0.4s; }
  .death-inner button {
    padding: 11px 26px; background: transparent; border: 1px solid #222;
    color: #666; font-family: 'Mono'; font-size: 10px; letter-spacing: 3px;
    text-transform: uppercase; cursor: pointer; transition: all 0.25s; border-radius: 2px;
  }
  .death-inner button:hover { border-color: #555; color: #ccc; }
  #challenge-btn { background: rgba(120,255,180,0.04); border-color: rgba(120,255,180,0.15); color: #5a9; }
  #challenge-btn:hover { background: rgba(120,255,180,0.1); border-color: #78FFB4; color: #78FFB4; }
  .legend-footer { display: flex; flex-direction: column; align-items: center; gap: 10px; margin-top: 28px; animation-delay: 0.5s; }
  .legend-footer .legend-wordmark { opacity: 0.3; }
  .legend-footer .legend-wordmark svg { height: 15px; width: auto; }
  .legend-footer .cta-text { font-family: 'Mono'; font-size: 10px; letter-spacing: 3px; text-transform: uppercase; color: #333; }
  .legend-footer .app-store-link { display: inline-block; transition: opacity 0.2s; }
  .legend-footer .app-store-link:hover { opacity: 0.7; }
  .legend-footer .app-store-link img { height: 38px; width: auto; border-radius: 6px; }

  /* ---- SHARE ---- */
  #share-card-wrap { display: none; position: fixed; inset: 0; z-index: 40; background: rgba(0,0,0,0.97); flex-direction: column; align-items: center; justify-content: center; gap: 18px; }
  #share-card-wrap.visible { display: flex; }
  #share-card-wrap canvas { border-radius: 10px; max-width: 92vw; max-height: 55vh; box-shadow: 0 4px 40px rgba(0,0,0,0.5); }
  .share-actions { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
  .share-actions button { padding: 10px 22px; background: transparent; border: 1px solid #222; color: #666; font-family: 'Mono'; font-size: 10px; letter-spacing: 2px; text-transform: uppercase; cursor: pointer; transition: all 0.2s; border-radius: 2px; }
  .share-actions button:hover { border-color: #888; color: #fff; }
  .share-actions .primary-share { background: rgba(120,255,180,0.05); border-color: rgba(120,255,180,0.2); color: #5a9; }
  .share-actions .primary-share:hover { background: rgba(120,255,180,0.12); border-color: #78FFB4; color: #78FFB4; }
  /* end run button (legend mode) */
  #end-run-btn {
    display: none; position: fixed; bottom: 20px; right: 20px; z-index: 8;
    padding: 10px 20px; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);
    border: 1px solid rgba(120,255,180,0.2); border-radius: 4px;
    font-family: 'Mono'; font-size: 9px; letter-spacing: 3px; text-transform: uppercase;
    color: #78FFB4; cursor: pointer; transition: all 0.3s;
    animation: breathe 3s ease-in-out infinite;
  }
  #end-run-btn:hover { background: rgba(120,255,180,0.08); border-color: #78FFB4; color: #fff; }

  /* legend victory screen */
  .death-inner.victory .label-tag { color: #78FFB4; }
  .death-inner.victory .big-stat em { color: #78FFB4; }
  .death-inner.victory .sub-stat em { color: #FFD700; }

  /* tutorial modal */
  #tutorial {
    display: none; position: fixed; inset: 0; z-index: 30;
    background: rgba(0,0,0,0.92); backdrop-filter: blur(10px);
    flex-direction: column; align-items: center; justify-content: center;
    color: #fff; cursor: pointer;
  }
  #tutorial.visible { display: flex; }
  .tut-inner { max-width: 380px; width: 100%; padding: 24px; }
  .tut-inner .tut-title { font-family: 'Knapp'; font-size: 28px; font-weight: 300; margin-bottom: 24px; text-align: center; }
  .tut-inner .tut-rules { list-style: none; counter-reset: rules; }
  .tut-inner .tut-rules li {
    counter-increment: rules;
    font-family: 'Mono'; font-size: 12px; color: #888; line-height: 1.7;
    padding: 10px 0; border-bottom: 1px solid #141414;
    padding-left: 32px; position: relative;
  }
  .tut-inner .tut-rules li::before {
    content: counter(rules);
    font-family: 'Mono'; font-size: 11px; font-weight: 700; color: #D4883A;
    position: absolute; left: 0; top: 10px;
  }
  .tut-inner .tut-rules li em { font-style: normal; color: #ff4444; }
  .tut-inner .tut-rules li strong { color: #78FFB4; font-weight: 500; }
  .tut-inner .tut-signoff {
    font-family: 'Knapp'; font-size: 13px; color: #444; text-align: center;
    margin-top: 24px; font-style: italic;
  }
  .tut-inner .tut-go {
    display: block; width: 100%; margin-top: 20px; padding: 14px;
    background: transparent; border: 1px solid #282828; border-radius: 3px;
    font-family: 'Mono'; font-size: 11px; letter-spacing: 4px; text-transform: uppercase;
    color: #D4883A; cursor: pointer; transition: all 0.25s; text-align: center;
  }
  .tut-inner .tut-go:hover { border-color: #D4883A; color: #fff; }

  #share-toast { position: fixed; bottom: 32px; left: 50%; transform: translateX(-50%); background: rgba(120,255,180,0.1); border: 1px solid rgba(120,255,180,0.2); color: #78FFB4; padding: 10px 28px; border-radius: 6px; font-family: 'Mono'; font-size: 11px; letter-spacing: 2px; z-index: 50; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
  #share-toast.visible { opacity: 1; }

  /* ---- LEADERBOARD ---- */
  #leaderboard {
    display: none; position: fixed; inset: 0; z-index: 35;
    background: rgba(0,0,0,0.97); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    flex-direction: column; align-items: center; justify-content: flex-start;
    padding: 0; overflow-y: auto; color: #fff;
  }
  #leaderboard.visible { display: flex; }
  .lb-inner {
    width: 100%; max-width: 520px; padding: 40px 24px 60px;
    display: flex; flex-direction: column; align-items: center;
  }
  .lb-header {
    display: flex; align-items: center; justify-content: space-between;
    width: 100%; margin-bottom: 28px;
  }
  .lb-header .lb-title { font-family: 'Knapp'; font-size: 28px; font-weight: 300; color: #fff; }
  .lb-header .lb-close {
    width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
    border: 1px solid #222; border-radius: 4px; cursor: pointer; transition: all 0.2s;
    background: transparent; color: #555; font-family: 'Mono'; font-size: 16px;
  }
  .lb-header .lb-close:hover { border-color: #555; color: #fff; }
  .lb-week {
    font-family: 'Mono'; font-size: 9px; letter-spacing: 4px; text-transform: uppercase;
    color: #444; margin-bottom: 24px; width: 100%; text-align: left;
    padding-bottom: 12px; border-bottom: 1px solid #141414;
  }
  .lb-week span { color: #78FFB4; }
  .lb-table { width: 100%; }
  .lb-row {
    display: grid; grid-template-columns: 32px 1fr auto; gap: 12px;
    align-items: center; padding: 12px 0;
    border-bottom: 1px solid #0e0e0e; transition: background 0.15s;
  }
  .lb-row:hover { background: rgba(255,255,255,0.015); }
  .lb-row.you { background: rgba(120,255,180,0.03); }
  .lb-row.top3 .lb-rank { color: #D4883A; }
  .lb-rank {
    font-family: 'Mono'; font-size: 11px; font-weight: 700; color: #333;
    text-align: center;
  }
  .lb-player {
    display: flex; align-items: center; gap: 8px;
  }
  .lb-handle {
    font-family: 'Mono'; font-size: 13px; font-weight: 500; color: #ccc;
  }
  .lb-badge {
    display: inline-flex; align-items: center; justify-content: center;
    width: 16px; height: 16px; border-radius: 3px;
  }
  .lb-badge svg { width: 10px; height: 10px; }
  .lb-badge.legend-badge { background: rgba(120,255,180,0.12); }
  .lb-badge.x-badge { background: rgba(255,255,255,0.06); }
  .lb-you-tag {
    font-family: 'Mono'; font-size: 8px; letter-spacing: 2px;
    text-transform: uppercase; color: #78FFB4; margin-left: 4px;
  }
  .lb-score {
    font-family: 'Mono'; font-size: 13px; font-weight: 700; color: #fff;
    text-align: right;
  }
  .lb-score .unit { font-weight: 400; color: #444; font-size: 10px; margin-left: 2px; }

  .lb-prize-banner {
    width: 100%; margin-top: 28px; padding: 16px 20px;
    border: 1px solid #1a1a1a; border-radius: 6px;
    display: flex; align-items: center; justify-content: space-between;
    background: rgba(255,255,255,0.01);
  }
  .lb-prize-banner .prize-label {
    font-family: 'Mono'; font-size: 9px; letter-spacing: 3px;
    text-transform: uppercase; color: #444;
  }
  .lb-prize-banner .prize-amount {
    font-family: 'Knapp'; font-size: 22px; font-weight: 300; color: #78FFB4;
  }
  .lb-prize-banner .prize-target {
    font-family: 'Mono'; font-size: 9px; color: #333; letter-spacing: 2px; text-transform: uppercase;
  }

  /* leaderboard button on start/death */
  .lb-btn {
    font-family: 'Mono'; font-size: 9px; letter-spacing: 3px;
    text-transform: uppercase; color: #444; cursor: pointer;
    pointer-events: auto; transition: color 0.2s; background: none; border: none;
    padding: 8px 0; margin-top: 8px;
  }
  .lb-btn:hover { color: #888; }
  .start-center .lb-btn { margin-top: 20px; }

  /* prize ticker */
  .prize-ticker {
    position: absolute; bottom: 90px; left: 50%; transform: translateX(-50%);
    z-index: 2; display: flex; flex-direction: column; align-items: center;
    gap: 4px; pointer-events: none;
  }
  .prize-ticker .earning-label {
    font-family: 'Mono', monospace; font-size: 11px; letter-spacing: 2px;
    color: #78FFB4;
  }
  .prize-ticker .ticker-amount {
    display: flex; align-items: baseline; font-family: 'Knapp', sans-serif;
    font-weight: 300; line-height: 1;
  }
  .prize-ticker .ticker-amount .main-digits { font-size: 38px; color: #ccc; }
  .prize-ticker .ticker-amount .micro-digits {
    font-size: 22px; color: #555;
  }
  .prize-ticker .ticker-amount .digit-slot {
    display: inline-block; position: relative; overflow: hidden;
    height: 1.15em; vertical-align: bottom;
  }
  .prize-ticker .ticker-amount .digit-slot .digit-inner {
    display: inline-block; transition: transform 0.12s ease-out;
  }
  .prize-ticker .ticker-divider {
    width: 60px; height: 1px; background: rgba(255,255,255,0.06); margin: 6px 0;
  }
  .prize-ticker .prize-countdown {
    font-family: 'Mono', monospace; font-size: 13px; color: #666; letter-spacing: 1px;
  }
  .prize-ticker .prize-info {
    font-family: 'Mono', monospace; font-size: 9px; letter-spacing: 2px;
    color: #555; text-transform: uppercase; text-align: center;
  }
  .prize-ticker .prize-info strong { color: #D4883A; font-weight: 500; }
</style>
</head>
<body>

<!-- ============ START SCREEN ============ -->
<div id="start-screen">
  <canvas id="start-canvas"></canvas>

  <div class="top-bar">
    <img src="logo.svg" alt="Legend" style="height:22px;width:auto;" />
  </div>

  <img class="bg-illustration" src="illustration.svg" alt="" />

  <div class="start-center">
    <img class="title-svg" src="title-text.svg" alt="FEE DODGE" />
    <div id="challenge-intro" class="challenge-intro" style="display:none;"></div>
    <button class="lb-btn" id="lb-open-start" onclick="event.stopPropagation();document.getElementById('leaderboard').classList.add('visible');">View Leaderboard</button>
  </div>

  <div class="prize-ticker" id="prize-ticker">
    <div class="earning-label">Earning 8.10%</div>
    <div class="ticker-amount">
      <span class="main-digits">$10,000.</span><span class="micro-digits"><span id="tk-d1" class="digit-slot"><span class="digit-inner">9</span></span><span id="tk-d2" class="digit-slot"><span class="digit-inner">1</span></span><span id="tk-d3" class="digit-slot"><span class="digit-inner">0</span></span><span id="tk-d4" class="digit-slot"><span class="digit-inner">5</span></span><span id="tk-d5" class="digit-slot"><span class="digit-inner">7</span></span></span>
    </div>
    <div class="ticker-divider"></div>
    <div class="prize-countdown" id="prize-countdown">12:41:30</div>
    <div class="prize-info">TOP SCORE WINS <strong>1,001.1234 USDC</strong></div>
  </div>

  <div class="corner-icon left" id="icon-left">
    <img src="icon-dark.svg" alt="" class="icon-img" />
  </div>
  <div class="corner-icon right" id="icon-right">
    <img src="icon-dark.svg" alt="" class="icon-img" />
  </div>
  <div id="legend-mode-toast">Legend Mode Unlocked</div>
</div>

<canvas id="game"></canvas>
<button id="end-run-btn">End Run</button>

<!-- ============ TUTORIAL ============ -->
<div id="tutorial">
  <div class="tut-inner">
    <div class="tut-title">How to Play</div>
    <ul class="tut-rules">
      <li>Move your mouse (or finger) to dodge the <em>bank fees</em> flying at you</li>
      <li>Every fee that hits you drains your <em>$100 balance</em> — hit $0 and you're out</li>
      <li>Grab the <strong>+$20 REFUND</strong> blocks to heal — they're rare, don't miss them</li>
      <li>The game gets harder every 10 seconds. Survive as long as you can.</li>
      <li>Surprises await. Stay sharp.</li>
    </ul>
    <div class="tut-signoff">Your bank has been training for this moment.<br>You have not. Good luck.</div>
    <button class="tut-go" id="tut-go-btn">Let's Go</button>
  </div>
</div>

<!-- ============ DEATH SCREEN ============ -->
<div id="death-screen">
  <div class="death-inner">
    <div class="label-tag">Game Over</div>
    <div class="big-stat">You survived <em id="ds-years">0</em> years</div>
    <div class="sub-stat">Lost <em id="ds-total">$0</em> to fees</div>
    <div class="fees-list" id="ds-fees"></div>
    <div class="editorial" id="ds-editorial">The average American pays $138,000+ in banking fees over a lifetime. On Legend: $0.</div>
    <div class="actions-row">
      <button id="retry-btn">Try Again</button>
      <button id="challenge-btn">Challenge a Friend</button>
    </div>
    <button class="lb-btn" id="lb-open-death" onclick="document.getElementById('leaderboard').classList.add('visible');">View Leaderboard</button>
    <div class="legend-footer">
      <div class="legend-wordmark">
        <svg viewBox="0 0 160 28" fill="none"><path d="M45.71 6.79H42.41V21.21H56.49V18.46H45.71V6.79Z" fill="white"/><path d="M62.93 12.61V9.54H75.03V6.79H59.63V21.21H75.03V18.46H62.93V15.35H74.65V12.61H62.93Z" fill="white"/><path d="M87.63 6.63C84.26 6.63 81.79 7.27 80.16 8.5C78.51 9.75 77.75 11.58 77.75 13.9V14.1C77.75 16.41 78.52 18.24 80.14 19.49C81.74 20.73 84.15 21.37 87.37 21.37H88.05C90.85 21.37 93.63 20.97 96.36 20.38V12.61H87.14V15.35H93.34V18.08C91.75 18.4 90.02 18.62 88.21 18.62H87.51C85.29 18.62 83.72 18.2 82.71 17.43C81.7 16.67 81.22 15.56 81.22 14.1V13.9C81.22 12.44 81.69 11.32 82.69 10.57C83.71 9.8 85.31 9.38 87.63 9.38H88.33C90.99 9.38 93.82 9.9 96.36 10.65V7.76C93.81 7.07 90.98 6.63 88.33 6.63H87.63Z" fill="white"/><path d="M103.34 12.61V9.54H115.44V6.79H100.04V21.21H115.44V18.46H103.34V15.35H115.07V12.61H103.34Z" fill="white"/><path fill-rule="evenodd" clip-rule="evenodd" d="M156.33 8.73C154.96 7.48 152.86 6.79 149.94 6.79H140.31V21.21H149.94C152.9 21.21 154.99 20.5 156.35 19.24C157.71 17.97 158.3 16.18 158.3 14.08V13.88C158.3 11.77 157.7 9.99 156.33 8.73ZM143.61 9.54V18.46H149.88C151.72 18.46 152.94 18.02 153.71 17.28C154.47 16.53 154.81 15.45 154.81 14.08V13.88C154.81 12.53 154.47 11.46 153.71 10.72C152.94 9.98 151.72 9.54 149.88 9.54H143.61Z" fill="white"/><path d="M122.24 6.79H118.64V21.21H121.87V10.72L132.93 21.21H136.53V6.79H133.29V17.28L122.24 6.79Z" fill="white"/><path d="M14.37 28C19.04 28 23.17 25.87 25.79 22.54C25.89 22.42 25.94 22.36 25.96 22.28C25.97 22.22 25.97 22.15 25.96 22.08C25.94 22.01 25.89 21.95 25.79 21.83C23.17 18.49 19.04 16.34 14.39 16.34C9.74 16.34 5.61 18.49 2.99 21.83C2.89 21.95 2.85 22.01 2.83 22.08C2.81 22.15 2.81 22.22 2.83 22.28C2.85 22.36 2.89 22.42 2.99 22.54C5.61 25.87 9.74 28 14.37 28ZM14.37 0C6.44 0 0 6.27 0 14C0 16.47 0.65 18.78 1.81 20.79C1.88 20.92 1.91 20.98 1.96 21C2.01 21.02 2.06 21.03 2.11 21.01C2.16 21 2.21 20.94 2.3 20.83L13.92 6.42C14.08 6.22 14.16 6.12 14.26 6.09C14.34 6.06 14.44 6.06 14.52 6.09C14.62 6.12 14.7 6.22 14.86 6.42L26.49 20.83C26.58 20.94 26.62 21 26.68 21.01C26.72 21.03 26.78 21.02 26.82 21C26.87 20.98 26.9 20.92 26.97 20.79C28.13 18.78 28.78 16.47 28.78 14C28.78 6.27 22.34 0 14.37 0Z" fill="white"/></svg>
      </div>
      <div class="cta-text">Skip the fees. Get started today.</div>
      <a class="app-store-link" href="https://apps.apple.com/us/app/legend-xyz/id6504718187" target="_blank" rel="noopener noreferrer">
        <img src="https://legend.xyz/footer/cta-app-store@2x.webp" alt="Download on the App Store" />
      </a>
    </div>
  </div>
</div>

<!-- ============ LEADERBOARD ============ -->
<div id="leaderboard">
  <div class="lb-inner">
    <div class="lb-header">
      <div class="lb-title">Leaderboard</div>
      <button class="lb-close" id="lb-close-btn">&times;</button>
    </div>
    <div class="lb-week">This week <span>&middot; Feb 17 – 23</span></div>

    <div class="lb-table" id="lb-table"></div>

    <div class="lb-prize-banner">
      <div>
        <div class="prize-label">Daily Prize</div>
        <div class="prize-amount">$1,000 USDC</div>
      </div>
      <div class="prize-target">Top score wins &middot; 10 days</div>
    </div>
  </div>
</div>

<div id="share-card-wrap">
  <canvas id="share-card" width="600" height="315"></canvas>
  <div class="share-actions">
    <button class="primary-share" id="share-copy-btn">Copy Link</button>
    <button id="share-save-btn">Save Image</button>
    <button id="share-close-btn">Close</button>
  </div>
</div>
<div id="share-toast">Link copied!</div>

<!-- ============ START SCREEN CANVAS ============ -->
<script>
(function() {
  const sc = document.getElementById('start-canvas'), sctx = sc.getContext('2d');
  let sw, sh;
  function sResize() { sw = sc.width = window.innerWidth; sh = sc.height = window.innerHeight; }
  sResize(); window.addEventListener('resize', sResize);

  const mouse = { x: -999, y: -999, active: false };
  const sm = { x: 0, y: 0 };
  const startEl = document.getElementById('start-screen');

  startEl.addEventListener('mousemove', e => { mouse.x = e.clientX; mouse.y = e.clientY; mouse.active = true; });
  startEl.addEventListener('touchmove', e => { mouse.x = e.touches[0].clientX; mouse.y = e.touches[0].clientY; mouse.active = true; }, { passive: true });
  startEl.addEventListener('touchstart', e => { mouse.x = e.touches[0].clientX; mouse.y = e.touches[0].clientY; mouse.active = true; }, { passive: true });

  const FEES = ['$4.86 ATM Fee','$26.77 Overdraft','$13.95 Monthly Fee','$35 Wire Fee','$2.50 Paper Fee','$5 Inactivity Fee','3% Foreign Txn','$12 Acct Analysis','$15 Returned Item','$25 Stop Payment','Fine Print Fee','$10 Low Balance','$7.50 Check Fee','$30 Cashier Check'];
  const ghosts = [];
  for (let i = 0; i < 16; i++) {
    const l = FEES[i % FEES.length];
    ghosts.push({ x: Math.random()*2000-200, y: 40+Math.random()*(800), w: 80+l.length*4.5, h: 22, vx: (Math.random()>.5?1:-1)*(0.1+Math.random()*0.25), vy: (Math.random()-.5)*0.06, label: l });
  }

  let gridOff = 0, amb = 0, t = 0;

  function draw() {
    if (startEl.classList.contains('hidden')) return;
    t++; gridOff = (gridOff + 0.1) % 40;
    if (!mouse.active) { amb += 0.002; mouse.x = sw/2 + Math.cos(amb)*sw*0.15; mouse.y = sh/2 + Math.sin(amb*0.6)*sh*0.1; }
    sm.x += (mouse.x - sm.x) * 0.07; sm.y += (mouse.y - sm.y) * 0.07;
    const mx = sm.x, my = sm.y;

    sctx.fillStyle = '#000'; sctx.fillRect(0, 0, sw, sh);
    const lr = 280;

    // grid revealed by light
    sctx.lineWidth = 0.5;
    for (let x = 0; x < sw; x += 40) {
      const d = Math.abs(x - mx); if (d > lr) continue;
      sctx.strokeStyle = `rgba(120,255,180,${Math.pow(1-d/lr,2)*0.06})`;
      sctx.beginPath(); sctx.moveTo(x,0); sctx.lineTo(x,sh); sctx.stroke();
    }
    for (let y = gridOff%40; y < sh; y += 40) {
      const d = Math.abs(y - my); if (d > lr) continue;
      sctx.strokeStyle = `rgba(120,255,180,${Math.pow(1-d/lr,2)*0.06})`;
      sctx.beginPath(); sctx.moveTo(0,y); sctx.lineTo(sw,y); sctx.stroke();
    }

    // ghost fees
    for (const g of ghosts) {
      g.x += g.vx; g.y += g.vy;
      if (g.x > sw+80) g.x = -g.w-10; if (g.x < -g.w-80) g.x = sw+10;
      if (g.y < 20 || g.y > sh-20) g.vy *= -1;
      const cx = g.x+g.w/2, cy = g.y+g.h/2;
      const d = Math.sqrt((cx-mx)**2+(cy-my)**2); if (d > lr+30) continue;
      const rv = Math.pow(Math.max(0,1-d/lr),1.5);
      sctx.globalAlpha = rv * 0.45;
      sctx.fillStyle = 'rgba(255,50,50,0.05)'; sctx.strokeStyle = `rgba(255,55,55,${rv*0.35})`; sctx.lineWidth = 0.7;
      sctx.beginPath(); const rr=3;
      sctx.moveTo(g.x+rr,g.y); sctx.lineTo(g.x+g.w-rr,g.y); sctx.arcTo(g.x+g.w,g.y,g.x+g.w,g.y+rr,rr);
      sctx.lineTo(g.x+g.w,g.y+g.h-rr); sctx.arcTo(g.x+g.w,g.y+g.h,g.x+g.w-rr,g.y+g.h,rr);
      sctx.lineTo(g.x+rr,g.y+g.h); sctx.arcTo(g.x,g.y+g.h,g.x,g.y+g.h-rr,rr);
      sctx.lineTo(g.x,g.y+rr); sctx.arcTo(g.x,g.y,g.x+rr,g.y,rr);
      sctx.closePath(); sctx.fill(); sctx.stroke();
      sctx.fillStyle = `rgba(255,55,55,${rv*0.5})`; sctx.font = `bold ${sw<500?7:9}px Mono, monospace`;
      sctx.textAlign = 'center'; sctx.textBaseline = 'middle'; sctx.fillText(g.label, cx, cy);
      sctx.globalAlpha = 1;
    }

    // soft light cone
    const grd = sctx.createRadialGradient(mx, my, 0, mx, my, lr);
    grd.addColorStop(0, 'rgba(120,255,180,0.03)'); grd.addColorStop(0.5, 'rgba(120,255,180,0.008)'); grd.addColorStop(1, 'rgba(120,255,180,0)');
    sctx.fillStyle = grd; sctx.fillRect(0, 0, sw, sh);

    // cursor dot
    if (mouse.active) {
      sctx.beginPath(); sctx.arc(mx, my, 4, 0, Math.PI*2);
      sctx.fillStyle = 'rgba(120,255,180,0.1)'; sctx.fill();
      sctx.beginPath(); sctx.arc(mx, my, 2, 0, Math.PI*2);
      sctx.fillStyle = 'rgba(120,255,180,0.25)'; sctx.fill();
    }

    requestAnimationFrame(draw);
  }
  requestAnimationFrame(draw);
})();

// Prize ticker — odometer digits + countdown
(function() {
  const BASE = 10000;
  const RATE = 0.0810;
  const PER_SEC = BASE * RATE / (365.25 * 24 * 3600);
  const INITIAL_EARNED = 0.91;
  const startT = Date.now();
  const slots = [
    document.getElementById('tk-d1'),
    document.getElementById('tk-d2'),
    document.getElementById('tk-d3'),
    document.getElementById('tk-d4'),
    document.getElementById('tk-d5'),
  ];
  const countdownEl = document.getElementById('prize-countdown');
  let prevDigits = [9, 1, 0, 5, 7];

  function tick() {
    const elapsed = (Date.now() - startT) / 1000;
    const totalEarned = INITIAL_EARNED + elapsed * PER_SEC;
    const frac = totalEarned - Math.floor(totalEarned);
    const micro = Math.floor(frac * 100000);
    const d = [
      Math.floor(micro / 10000) % 10,
      Math.floor(micro / 1000) % 10,
      Math.floor(micro / 100) % 10,
      Math.floor(micro / 10) % 10,
      micro % 10,
    ];

    for (let i = 0; i < 5; i++) {
      if (d[i] !== prevDigits[i]) {
        const inner = slots[i].querySelector('.digit-inner');
        inner.style.transform = 'translateY(-100%)';
        inner.style.transition = 'transform 0.1s ease-out';
        const newD = d[i];
        setTimeout(() => {
          inner.style.transition = 'none';
          inner.style.transform = 'translateY(100%)';
          inner.textContent = newD;
          requestAnimationFrame(() => {
            requestAnimationFrame(() => {
              inner.style.transition = 'transform 0.1s ease-out';
              inner.style.transform = 'translateY(0)';
            });
          });
        }, 100);
        prevDigits[i] = d[i];
      }
    }

    // countdown to midnight UTC
    const now = new Date();
    const midnight = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() + 1));
    const rem = Math.max(0, Math.floor((midnight - now) / 1000));
    const hh = String(Math.floor(rem / 3600)).padStart(2, '0');
    const mm = String(Math.floor((rem % 3600) / 60)).padStart(2, '0');
    const ss = String(rem % 60).padStart(2, '0');
    countdownEl.textContent = `${hh}:${mm}:${ss}`;

    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
})();

// corner icon easter egg
(function() {
  const left = document.getElementById('icon-left');
  const right = document.getElementById('icon-right');
  const toast = document.getElementById('legend-mode-toast');
  let leftActive = false, rightActive = false;
  window._legendMode = false;
  let _ac = null;
  function getAC() { if (!_ac) _ac = new (window.AudioContext || window.webkitAudioContext)(); return _ac; }

  function playPowerUp() {
    const ac = getAC();
    const o1 = ac.createOscillator(), g1 = ac.createGain();
    o1.type = 'sine'; o1.frequency.value = 400; g1.gain.value = 0.09;
    o1.connect(g1); g1.connect(ac.destination); o1.start();
    o1.frequency.exponentialRampToValueAtTime(900, ac.currentTime + 0.25);
    g1.gain.exponentialRampToValueAtTime(0.001, ac.currentTime + 0.35);
    o1.stop(ac.currentTime + 0.4);
    const o2 = ac.createOscillator(), g2 = ac.createGain();
    o2.type = 'sine'; o2.frequency.value = 600; g2.gain.value = 0.04;
    o2.connect(g2); g2.connect(ac.destination); o2.start(ac.currentTime + 0.05);
    o2.frequency.exponentialRampToValueAtTime(1300, ac.currentTime + 0.3);
    g2.gain.exponentialRampToValueAtTime(0.001, ac.currentTime + 0.4);
    o2.stop(ac.currentTime + 0.45);
  }

  function playLegendUnlock() {
    const ac = getAC();
    [523, 659, 784, 1047, 1319].forEach((f, i) => {
      const o = ac.createOscillator(), g = ac.createGain();
      o.type = 'sine'; o.frequency.value = f; g.gain.value = 0.07 - i * 0.008;
      o.connect(g); g.connect(ac.destination);
      o.start(ac.currentTime + i * 0.07);
      g.gain.exponentialRampToValueAtTime(0.001, ac.currentTime + i * 0.07 + 0.3);
      o.stop(ac.currentTime + i * 0.07 + 0.35);
    });
    const ob = ac.createOscillator(), gb = ac.createGain();
    ob.type = 'triangle'; ob.frequency.value = 80; gb.gain.value = 0.12;
    ob.connect(gb); gb.connect(ac.destination); ob.start();
    ob.frequency.exponentialRampToValueAtTime(35, ac.currentTime + 0.5);
    gb.gain.exponentialRampToValueAtTime(0.001, ac.currentTime + 0.6);
    ob.stop(ac.currentTime + 0.65);
  }

  window._playSmash = function() {
    try {
      const ac = getAC();
      const o = ac.createOscillator(), g = ac.createGain(), f = ac.createBiquadFilter();
      o.type = 'square'; o.frequency.value = 150; f.type = 'lowpass'; f.frequency.value = 400; f.Q.value = 2;
      g.gain.value = 0.1; o.connect(f); f.connect(g); g.connect(ac.destination); o.start();
      o.frequency.exponentialRampToValueAtTime(40, ac.currentTime + 0.12);
      g.gain.exponentialRampToValueAtTime(0.001, ac.currentTime + 0.15);
      o.stop(ac.currentTime + 0.18);
    } catch(e) {}
  };

  function check() {
    if (leftActive && rightActive) {
      if (!window._legendMode) {
        window._legendMode = true;
        playLegendUnlock();
        toast.classList.add('visible');
        document.body.style.setProperty('--legend-mode', '1');
        setTimeout(() => toast.classList.remove('visible'), 3000);
      }
    } else {
      if (window._legendMode) {
        window._legendMode = false;
        document.body.style.removeProperty('--legend-mode');
      }
    }
  }

  left.addEventListener('click', e => {
    e.stopPropagation(); leftActive = !leftActive;
    left.classList.toggle('active', leftActive);
    left.querySelector('.icon-img').src = leftActive ? 'icon-light.svg' : 'icon-dark.svg';
    if (leftActive) playPowerUp();
    check();
  });
  right.addEventListener('click', e => {
    e.stopPropagation(); rightActive = !rightActive;
    right.classList.toggle('active', rightActive);
    right.querySelector('.icon-img').src = rightActive ? 'icon-light.svg' : 'icon-dark.svg';
    if (rightActive) playPowerUp();
    check();
  });
})();
</script>

<!-- ============ GAME ENGINE ============ -->
<script>
const canvas = document.getElementById('game'), ctx = canvas.getContext('2d');
let audioCtx, masterGain, bassOsc, bassGain, droneOsc, droneGain, audioStarted = false;

function initAudio() {
  if (audioStarted) return; audioStarted = true;
  audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  masterGain = audioCtx.createGain(); masterGain.gain.value = 0.25; masterGain.connect(audioCtx.destination);
  droneOsc = audioCtx.createOscillator(); droneGain = audioCtx.createGain();
  droneOsc.type='sine'; droneOsc.frequency.value=55; droneGain.gain.value=0.05;
  droneOsc.connect(droneGain); droneGain.connect(masterGain); droneOsc.start();
  bassOsc = audioCtx.createOscillator(); bassGain = audioCtx.createGain();
  bassOsc.type='triangle'; bassOsc.frequency.value=82.4; bassGain.gain.value=0;
  bassOsc.connect(bassGain); bassGain.connect(masterGain); bassOsc.start();
}
function playHit(v){if(!audioCtx)return;const o=audioCtx.createOscillator(),g=audioCtx.createGain(),f=audioCtx.createBiquadFilter();o.type='sawtooth';o.frequency.value=100+Math.min(v,35)*10;f.type='lowpass';f.frequency.value=600+v*20;f.Q.value=6;g.gain.value=0.12;o.connect(f);f.connect(g);g.connect(masterGain);o.start();g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.2);o.stop(audioCtx.currentTime+0.25);}
function playNM(){if(!audioCtx)return;const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type='sine';o.frequency.value=1400;g.gain.value=0.03;o.connect(g);g.connect(masterGain);o.start();o.frequency.exponentialRampToValueAtTime(700,audioCtx.currentTime+0.07);g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.09);o.stop(audioCtx.currentTime+0.1);}
function playDeath(){if(!audioCtx)return;const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type='sawtooth';o.frequency.value=180;g.gain.value=0.18;o.connect(g);g.connect(masterGain);o.start();o.frequency.exponentialRampToValueAtTime(25,audioCtx.currentTime+1);g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+1.2);o.stop(audioCtx.currentTime+1.3);if(droneGain)droneGain.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.6);}
function playDodge(){if(!audioCtx)return;const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type='sine';o.frequency.value=600+dodgeStreak*80;g.gain.value=0.015;o.connect(g);g.connect(masterGain);o.start();o.frequency.exponentialRampToValueAtTime(o.frequency.value*1.2,audioCtx.currentTime+0.05);g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.08);o.stop(audioCtx.currentTime+0.1);}
function updateDrone(s){if(!droneOsc)return;droneOsc.frequency.value=55+s*6;droneGain.gain.value=Math.min(0.1,0.03+s*0.006);}
function pulseBass(){if(!bassGain)return;bassGain.gain.cancelScheduledValues(audioCtx.currentTime);bassGain.gain.setValueAtTime(0.06,audioCtx.currentTime);bassGain.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.25);}

let W,H; function resize(){W=canvas.width=window.innerWidth;H=canvas.height=window.innerHeight;} resize(); window.addEventListener('resize',resize);

const FEES=[
  {label:'$4.86 ATM Fee',value:4.86,speed:1,color:'#ff4444'},
  {label:'$26.77 Overdraft',value:26.77,speed:0.65,color:'#ff6633'},
  {label:'$13.95 Monthly Fee',value:13.95,speed:0.85,color:'#ff5544'},
  {label:'$35 Wire Fee',value:35,speed:0.55,color:'#ff3322'},
  {label:'$2.50 Paper Fee',value:2.50,speed:1.15,color:'#cc4444'},
  {label:'$5 Inactivity Fee',value:5,speed:1.05,color:'#dd5555'},
  {label:'3% Foreign Txn',value:15,speed:0.9,color:'#ee4433'},
  {label:'$12 Acct Analysis',value:12,speed:0.75,color:'#dd3333'},
  {label:'$15 Returned Item',value:15,speed:0.7,color:'#ff2222'},
  {label:'$25 Stop Payment',value:25,speed:0.6,color:'#ee3344'},
  {label:'Fine Print Fee',value:8,speed:1.2,color:'#883333',stealth:true},
  {label:'$10 Low Balance',value:10,speed:0.9,color:'#cc3322'},
];

let player,obstacles,balance,distance,gameSpeed,frameCount,totalFeesHit,feesHitMap;
let gameState='start',shakeAmount=0,flashAmount=0;
let particles=[],trailPoints=[];
let nearMissTimer=0,nearMissCount=0,gridOffset=0,dodgedCount=0,dodgeStreak=0;
let hitShrink=0,bestYears=parseFloat(localStorage.getItem('fd_best')||'0');
let legendFeesSmashed=0,legendFeesValue=0,legendRunStart=0;

// distraction system
const DISTRACTIONS = [
  { at: 20, name: 'BANKER HOURS', duration: 360, announced: false, active: false, startFrame: 0 },
  { at: 40, name: 'FEE MAGNET', duration: 420, announced: false, active: false, startFrame: 0 },
  { at: 60, name: 'INVERTED', duration: 300, announced: false, active: false, startFrame: 0 },
];
let announceText = '', announceTimer = 0;
let distractionControlDrift = { x: 0, y: 0 };
const pt={x:0,y:0};

function initGame(){
  player={x:W/2,y:H*0.75,radius:13};pt.x=player.x;pt.y=player.y;
  obstacles=[];particles=[];trailPoints=[];
  balance=100;distance=0;gameSpeed=1.875;frameCount=0;
  totalFeesHit=0;feesHitMap={};shakeAmount=0;flashAmount=0;
  nearMissTimer=0;nearMissCount=0;dodgedCount=0;dodgeStreak=0;hitShrink=0;
  legendFeesSmashed=0;legendFeesValue=0;legendRunStart=Date.now();
  DISTRACTIONS.forEach(d=>{d.announced=false;d.active=false;d.startFrame=0;});
  announceText='';announceTimer=0;
  gameState='playing';initAudio();
  document.getElementById('end-run-btn').style.display='none';
}

function spawnOb(){
  // 8% chance to spawn a health pickup instead
  if(Math.random()<0.08){
    const side=Math.random()>0.5;
    const w=95*(W<500?0.8:1);
    obstacles.push({x:side?-w-10:W+10,y:80+Math.random()*(H*0.65),w,h:26,
      vx:(side?1:-1)*0.8*(0.85+Math.random()*0.3)*gameSpeed,
      vy:(Math.random()-0.5)*0.25*gameSpeed,
      label:'+$20 REFUND',value:-20,color:'#78FFB4',
      stealth:false,opacity:1,
      hit:false,nearMissed:false,rotation:(Math.random()-0.5)*0.01,angle:0,
      isPickup:true});
    return;
  }
  const fee=FEES[Math.floor(Math.random()*FEES.length)];
  const side=Math.random()>0.5;
  const bw=fee.label.length*7+20,sw2=bw*(W<500?0.8:1),h=fee.value>20?30:fee.value>10?27:24;
  obstacles.push({x:side?-sw2-10:W+10,y:80+Math.random()*(H*0.65),w:sw2,h,
    vx:(side?1:-1)*fee.speed*(0.85+Math.random()*0.3)*gameSpeed,
    vy:(Math.random()-0.5)*0.35*gameSpeed,
    label:fee.label,value:fee.value,color:fee.color,
    stealth:fee.stealth||false,opacity:fee.stealth?0:1,
    hit:false,nearMissed:false,rotation:(Math.random()-0.5)*0.015,angle:0});
}

function spawnP(x,y,c,n,s){for(let i=0;i<n;i++){const a=Math.random()*Math.PI*2,v=1+Math.random()*(s||5);particles.push({x,y,vx:Math.cos(a)*v,vy:Math.sin(a)*v,life:1,color:c,size:1.5+Math.random()*2.5});}}
function spawnSparks(x,y){for(let i=0;i<8;i++){const a=Math.random()*Math.PI*2,v=2+Math.random()*6;particles.push({x,y,vx:Math.cos(a)*v,vy:Math.sin(a)*v,life:1,color:'#78FFB4',size:1+Math.random(),spark:true});}}

canvas.addEventListener('mousemove',e=>{if(gameState==='playing'){pt.x=e.clientX;pt.y=e.clientY;}});
canvas.addEventListener('touchmove',e=>{e.preventDefault();if(gameState==='playing'){pt.x=e.touches[0].clientX;pt.y=e.touches[0].clientY;}},{passive:false});
canvas.addEventListener('touchstart',e=>{e.preventDefault();if(gameState==='playing'){pt.x=e.touches[0].clientX;pt.y=e.touches[0].clientY;}},{passive:false});

document.getElementById('start-screen').addEventListener('click',()=>{
  document.getElementById('start-screen').classList.add('hidden');
  setTimeout(()=>{document.getElementById('start-screen').style.display='none';},500);
  document.getElementById('tutorial').classList.add('visible');
});
document.getElementById('tut-go-btn').addEventListener('click',()=>{
  document.getElementById('tutorial').classList.remove('visible');
  initGame();
});
document.getElementById('tutorial').addEventListener('click',(e)=>{
  if(e.target===document.getElementById('tutorial')){
    document.getElementById('tutorial').classList.remove('visible');
    initGame();
  }
});
document.getElementById('retry-btn').addEventListener('click',()=>{
  document.getElementById('death-screen').classList.remove('visible');
  const inner = document.querySelector('.death-inner');
  inner.classList.remove('victory');
  inner.querySelector('.label-tag').textContent = 'Game Over';
  inner.querySelector('.big-stat').innerHTML = 'You survived <em id="ds-years">0</em> years';
  inner.querySelector('.sub-stat').innerHTML = 'Lost <em id="ds-total">$0</em> to fees';
  document.getElementById('ds-editorial').innerHTML = 'The average American pays $138,000+ in banking fees over a lifetime. On Legend: $0.';
  initGame();
});
document.getElementById('end-run-btn').addEventListener('click',()=>{
  gameState='dead';
  document.getElementById('end-run-btn').style.display='none';
  showVictory();
});

function getYears(){return(distance/800).toFixed(1);}
function balColor(b){
  if(b>60)return'#78FFB4';
  if(b>35){const t=(b-35)/25;return lc('#FFD666','#78FFB4',t);}
  if(b>15){const t=(b-15)/20;return lc('#ff5544','#FFD666',t);}
  return'#ff4444';
}
function lc(a,b,t){const pa=[parseInt(a.slice(1,3),16),parseInt(a.slice(3,5),16),parseInt(a.slice(5,7),16)];const pb=[parseInt(b.slice(1,3),16),parseInt(b.slice(3,5),16),parseInt(b.slice(5,7),16)];return`rgb(${Math.round(pa[0]+(pb[0]-pa[0])*t)},${Math.round(pa[1]+(pb[1]-pa[1])*t)},${Math.round(pa[2]+(pb[2]-pa[2])*t)})`;}

function update(){
  if(gameState!=='playing')return;
  frameCount++;distance+=gameSpeed;
  const gameSecs=frameCount/60;
  const tierBoost=Math.floor(gameSecs/10)*0.15;
  const postSixtyBoost=gameSecs>60?(gameSecs-60)*0.008:0;
  gameSpeed=1.875+distance*0.000375+tierBoost+postSixtyBoost;
  gridOffset=(gridOffset+gameSpeed*0.25)%40;hitShrink*=0.88;
  updateDrone(gameSpeed);if(frameCount%28===0)pulseBass();
  const sr=Math.max(8,38-distance*0.009-tierBoost*3);if(frameCount%Math.floor(sr)===0)spawnOb();

  const moveSpeed = DISTRACTIONS[0].active ? 0.05 : 0.14;
  player.x+=(pt.x-player.x)*moveSpeed;player.y+=(pt.y-player.y)*moveSpeed;
  player.x=Math.max(player.radius,Math.min(W-player.radius,player.x));
  player.y=Math.max(player.radius,Math.min(H-player.radius,player.y));

  trailPoints.unshift({x:player.x,y:player.y,life:1});
  if(trailPoints.length>24)trailPoints.pop();
  trailPoints.forEach(p=>p.life-=0.045);
  nearMissTimer=Math.max(0,nearMissTimer-1);

  for(let i=obstacles.length-1;i>=0;i--){
    const ob=obstacles[i];ob.x+=ob.vx;ob.y+=ob.vy;ob.angle+=ob.rotation;
    if(ob.stealth){const dx=player.x-(ob.x+ob.w/2),dy=player.y-(ob.y+ob.h/2);ob.opacity=Math.max(0,Math.min(1,1-(Math.sqrt(dx*dx+dy*dy)-50)/90));}
    if(ob.x<-ob.w-50||ob.x>W+50||ob.y<-50||ob.y>H+50){if(!ob.hit){dodgedCount++;dodgeStreak++;playDodge();}obstacles.splice(i,1);continue;}
    if(!ob.hit){
      const cx=Math.max(ob.x,Math.min(player.x,ob.x+ob.w)),cy=Math.max(ob.y,Math.min(player.y,ob.y+ob.h));
      const dx=player.x-cx,dy=player.y-cy,dq=dx*dx+dy*dy,pr=player.radius*(1-hitShrink*0.3);
      if(!ob.nearMissed&&dq<(pr+16)*(pr+16)&&dq>pr*pr){ob.nearMissed=true;nearMissTimer=18;nearMissCount++;spawnSparks(cx,cy);playNM();}
      if(dq<pr*pr){
        // health pickup
        if(ob.isPickup){
          ob.hit=true;
          balance=Math.min(100,balance+20);
          spawnP(player.x,player.y,'#78FFB4',15,6);
          shakeAmount=3;
          if(audioCtx){const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type='sine';o.frequency.value=600;g.gain.value=0.07;o.connect(g);g.connect(masterGain);o.start();o.frequency.exponentialRampToValueAtTime(1200,audioCtx.currentTime+0.15);g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.2);o.stop(audioCtx.currentTime+0.25);}
          continue;
        }
        if(window._legendMode){
          ob.hit=true; dodgedCount++; dodgeStreak++;
          legendFeesSmashed++; legendFeesValue+=Math.abs(ob.value);
          const smashDx=ob.x+ob.w/2-player.x, smashDy=ob.y+ob.h/2-player.y;
          const smashDist=Math.sqrt(smashDx*smashDx+smashDy*smashDy)||1;
          ob.vx=(smashDx/smashDist)*18; ob.vy=(smashDy/smashDist)*18;
          ob.rotation=(Math.random()-0.5)*0.3;
          shakeAmount=6;
          spawnP(player.x,player.y,'#FFD700',15,9);
          spawnP(cx,cy,'#fff',8,5);
          if(window._playSmash)window._playSmash();
        } else {
          ob.hit=true;balance-=ob.value;totalFeesHit+=ob.value;feesHitMap[ob.label]=(feesHitMap[ob.label]||0)+ob.value;
          shakeAmount=12;flashAmount=1;hitShrink=1;dodgeStreak=0;spawnP(player.x,player.y,ob.color,20,7);playHit(ob.value);
          if(balance<=0){balance=0;gameState='dead';playDeath();showDeath();}
        }
      }
    }
  }
  particles=particles.filter(p=>{p.x+=p.vx;p.y+=p.vy;p.life-=p.spark?0.045:0.022;p.vx*=0.94;p.vy*=p.spark?0.9:0.95;if(p.spark)p.vy+=0.12;return p.life>0;});
  shakeAmount*=0.8;flashAmount*=0.82;

  // distraction system
  const gameSec = frameCount / 60;
  if(announceTimer > 0) announceTimer--;

  for(const d of DISTRACTIONS){
    if(!d.announced && gameSec >= d.at){
      d.announced = true;
      announceText = d.name;
      announceTimer = 150;
      d.startFrame = frameCount + 150;
    }
    if(d.announced && frameCount >= d.startFrame && frameCount < d.startFrame + d.duration){
      d.active = true;
    } else {
      d.active = false;
    }
  }

  // FEE MAGNET: curve fees toward player
  if(DISTRACTIONS[1].active){
    for(const ob of obstacles){
      if(ob.hit) continue;
      const dx = player.x - (ob.x + ob.w/2), dy = player.y - (ob.y + ob.h/2);
      const dist = Math.sqrt(dx*dx + dy*dy) || 1;
      ob.vx += (dx / dist) * 0.12;
      ob.vy += (dy / dist) * 0.12;
    }
  }

  // show End Run button after 30s in Legend Mode
  if(window._legendMode && gameState==='playing' && (Date.now()-legendRunStart)>30000){
    const btn=document.getElementById('end-run-btn');
    if(btn.style.display==='none') btn.style.display='block';
  }
}

function rr(c,x,y,w,h,r){if(c.roundRect){c.roundRect(x,y,w,h,r);return;}c.moveTo(x+r,y);c.lineTo(x+w-r,y);c.arcTo(x+w,y,x+w,y+r,r);c.lineTo(x+w,y+h-r);c.arcTo(x+w,y+h,x+w-r,y+h,r);c.lineTo(x+r,y+h);c.arcTo(x,y+h,x,y+h-r,r);c.lineTo(x,y+r);c.arcTo(x,y,x+r,y,r);c.closePath();}

// USDC blue for player in legend mode
const USDC_BLUE = '#2775CA';

// Story crawl text — Star Wars style background narrative
const STORY_LINES = [
  'Long, long ago...',
  '',
  'There was a time when people needed',
  'others to handle their assets.',
  '',
  'A time when it wasn\'t easy to buy,',
  'sell, or transfer what was yours —',
  'and someone else had to do it for you.',
  '',
  'A time of fees.',
  '',
  'Hidden fees. Monthly fees. Overdraft fees.',
  'Wire fees. ATM fees. Inactivity fees.',
  'Fees for using your own money.',
  '',
  'Over decades, these fees built',
  'enormous institutions whose sole purpose',
  'became taking money out of your pocket.',
  '',
  'The average U.S. savings rate?',
  '0.39% APY.',
  '',
  'You deposit $10,000.',
  'Your bank pays you $39 per year.',
  '',
  'But that same $10,000?',
  'Your bank lends it out at 7-8%.',
  'They earn $750. You get $39.',
  '',
  'They keep $711 of the value',
  'your money generated.',
  '',
  'You brought the assets.',
  'Why do they get paid?',
  '',
  'In 2025 alone, U.S. banks earned',
  '$730 billion in net interest income.',
  '',
  'Seven hundred and thirty billion.',
  'From your deposits.',
  '',
  'Meanwhile, $10.85 trillion sits',
  'in U.S. savings and checking accounts,',
  'earning almost nothing.',
  '',
  'The median American has $8,000 saved.',
  'At 0.39%, that\'s $31 per year.',
  '',
  'At 6.5% on DeFi?',
  'That same $8,000 earns $520.',
  '',
  'The difference: $489 per year.',
  'Every year. Compounding.',
  '',
  'Your bank doesn\'t want you',
  'to know this math.',
  '',
  'They call it "safety."',
  'They call it "convenience."',
  'They call it "trust."',
  '',
  'But trust is not a fee.',
  'Safety is not a percentage.',
  'And convenience should not cost you',
  '$138,000 over a lifetime.',
  '',
  'There is another way.',
  '',
  'A way where your money works for you.',
  '24 hours a day. 7 days a week.',
  'No middlemen. No hidden fees.',
  'No one taking a cut while you sleep.',
  '',
  'Self-custody. Real yield.',
  'Your keys. Your money. Your future.',
  '',
  'The old system was built for banks.',
  '',
  'The new one is built for you.',
];

const STORY_120 = [
  '',
  'Still here?',
  '',
  'Most people have already lost by now.',
  '',
  'The fees are relentless.',
  'They don\'t sleep. They don\'t stop.',
  'They don\'t care how good you are.',
  '',
  'Sound familiar?',
  '',
  'In the real world, you can\'t dodge fees.',
  'You can only eliminate them.',
  '',
  'One app. Zero fees.',
  'That\'s not a game.',
  'That\'s Legend.',
];

function draw(){
  if(!player){ctx.fillStyle='#000';ctx.fillRect(0,0,W,H);return;}
  ctx.save();
  if(shakeAmount>0.5)ctx.translate((Math.random()-.5)*shakeAmount*2,(Math.random()-.5)*shakeAmount*2);

  // INVERTED distraction — flip entire canvas
  if(DISTRACTIONS[2].active){
    ctx.translate(W/2, H/2);
    ctx.rotate(Math.PI);
    ctx.translate(-W/2, -H/2);
  }

  ctx.fillStyle='#000';ctx.fillRect(0,0,W,H);

  // grid
  const lm = window._legendMode;
  const gc = lm ? '38,112,196' : '120,255,180';
  const ga=0.02+gameSpeed*0.0025;
  ctx.strokeStyle=`rgba(${gc},${ga})`;ctx.lineWidth=0.5;
  for(let x=0;x<W;x+=40){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();}
  for(let y=-40+(gridOffset%40);y<H+40;y+=40){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}

  // horizon
  const hg=ctx.createLinearGradient(0,H*0.88,0,H);
  hg.addColorStop(0,`rgba(${gc},0)`);hg.addColorStop(1,`rgba(${gc},${0.015+gameSpeed*0.002})`);
  ctx.fillStyle=hg;ctx.fillRect(0,H*0.88,W,H*0.12);

  // vignette
  const vig=ctx.createRadialGradient(W/2,H/2,Math.min(W,H)*0.3,W/2,H/2,Math.max(W,H)*0.7);
  vig.addColorStop(0,'rgba(0,0,0,0)');vig.addColorStop(1,`rgba(0,0,0,${0.15+gameSpeed*0.02})`);
  ctx.fillStyle=vig;ctx.fillRect(0,0,W,H);

  if(flashAmount>0.05){ctx.fillStyle=`rgba(255,40,40,${flashAmount*0.07})`;ctx.fillRect(0,0,W,H);}

  // BANKER HOURS overlay — dim screen + CLOSED watermark
  if(DISTRACTIONS[0].active){
    ctx.fillStyle='rgba(0,0,0,0.35)';ctx.fillRect(0,0,W,H);
    ctx.save();
    ctx.translate(W/2,H/2);ctx.rotate(-0.15);
    ctx.fillStyle='rgba(255,255,255,0.03)';
    ctx.font=`bold ${W<500?40:80}px Knapp, sans-serif`;
    ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText('CLOSED',0,0);
    ctx.restore();
  }

  // FEE MAGNET overlay — subtle red vignette pulse
  if(DISTRACTIONS[1].active){
    const mp=0.5+Math.sin(frameCount*0.08)*0.3;
    const mv=ctx.createRadialGradient(player.x,player.y,50,player.x,player.y,300);
    mv.addColorStop(0,'rgba(0,0,0,0)');
    mv.addColorStop(1,`rgba(255,30,30,${0.04*mp})`);
    ctx.fillStyle=mv;ctx.fillRect(0,0,W,H);
  }

  // announcement text — big word slam
  if(announceTimer>0){
    const t=announceTimer/150;
    const scale=t>0.85?1+(1-t)/0.15*0.3:1;
    const alpha=t>0.2?Math.min(1,(1-t)/0.15*0.6+0.4):t/0.2;
    ctx.save();
    ctx.translate(W/2,H/2);
    ctx.scale(scale,scale);
    ctx.fillStyle=`rgba(255,255,255,${alpha*0.18})`;
    ctx.font=`500 ${W<500?48:90}px Knapp, sans-serif`;
    ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText(announceText,0,0);
    ctx.fillStyle=`rgba(255,146,20,${alpha*0.5})`;
    ctx.font=`500 ${W<500?46:88}px Knapp, sans-serif`;
    ctx.fillText(announceText,0,0);
    ctx.restore();
  }

  // story crawl — scrolling background text
  if(gameState==='playing'){
    const elapsed = frameCount / 60;
    const scrollSpeed = 0.6;
    const lineH = 36;
    const startY = H + 40;
    const offset = elapsed * scrollSpeed * lineH;
    const lines = STORY_LINES.concat(elapsed >= 120 ? STORY_120 : []);

    ctx.save();
    ctx.font = '300 21px Knapp, sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'top';

    for (let i = 0; i < lines.length; i++) {
      const y = startY - offset + i * lineH;
      if (y < -30 || y > H + 30) continue;

      // fade at edges
      let alpha = 0.088;
      if (y < 80) alpha *= y / 80;
      if (y > H - 60) alpha *= (H - y) / 60;
      if (alpha <= 0) continue;

      ctx.fillStyle = `rgba(255,255,255,${alpha})`;
      ctx.fillText(lines[i], W / 2, y);
    }

    // 120s distraction: pulsing warning text
    if (elapsed >= 120) {
      const pulse = 0.5 + Math.sin(frameCount * 0.05) * 0.3;
      ctx.font = 'bold 11px Mono, monospace';
      ctx.fillStyle = `rgba(255,68,68,${0.08 * pulse})`;
      ctx.fillText('THE FEES NEVER STOP', W / 2, H / 2 - 60);
      ctx.fillText('THE FEES NEVER STOP', W / 2, H / 2 + 60);
      // subtle scanline bars
      for (let y = (frameCount * 2) % 120; y < H; y += 120) {
        ctx.fillStyle = `rgba(255,40,40,${0.015 * pulse})`;
        ctx.fillRect(0, y, W, 2);
      }
    }

    ctx.restore();
  }

  // trail
  if(trailPoints.length>1){
    if(lm){
      // rainbow trail in legend mode — each segment a different hue
      ctx.lineCap='round';
      for(let i=0;i<trailPoints.length-1;i++){
        const p=trailPoints[i],p2=trailPoints[i+1];
        if(p.life<=0||p2.life<=0)break;
        const hue=(frameCount*3+i*18)%360;
        ctx.beginPath();ctx.moveTo(p.x,p.y);ctx.lineTo(p2.x,p2.y);
        ctx.strokeStyle=`hsla(${hue},100%,65%,${p.life*0.5})`;ctx.lineWidth=3.5*p.life;ctx.stroke();
      }
      // bright inner rainbow
      for(let i=0;i<Math.min(5,trailPoints.length-1);i++){
        const p=trailPoints[i],p2=trailPoints[i+1];
        if(p.life<=0||p2.life<=0)break;
        const hue=(frameCount*3+i*18)%360;
        ctx.beginPath();ctx.moveTo(p.x,p.y);ctx.lineTo(p2.x,p2.y);
        ctx.strokeStyle=`hsla(${hue},100%,80%,${p.life*0.7})`;ctx.lineWidth=1.5*p.life;ctx.stroke();
      }
    } else {
      ctx.beginPath();ctx.moveTo(trailPoints[0].x,trailPoints[0].y);
      for(let i=1;i<trailPoints.length;i++){if(trailPoints[i].life<=0)break;ctx.lineTo(trailPoints[i].x,trailPoints[i].y);}
      ctx.strokeStyle='rgba(120,255,180,0.25)';ctx.lineWidth=2.5;ctx.lineCap='round';ctx.stroke();
      ctx.beginPath();ctx.moveTo(trailPoints[0].x,trailPoints[0].y);
      for(let i=1;i<Math.min(6,trailPoints.length);i++){if(trailPoints[i].life<=0)break;ctx.lineTo(trailPoints[i].x,trailPoints[i].y);}
      ctx.strokeStyle='rgba(120,255,180,0.5)';ctx.lineWidth=1.2;ctx.stroke();
    }
  }

  // player
  const pr=player.radius*(1-hitShrink*0.3)*(lm?1.15:1);
  const sg=Math.min(dodgeStreak*0.015,0.2);
  const rainbowHue = (frameCount * 2) % 360;
  const pc = lm ? `hsl(${rainbowHue},90%,60%)` : '#78FFB4';
  const pcr = lm ? '38,112,196' : '120,255,180';

  // glow
  const glowR = lm ? 70 + sg * 120 + Math.sin(frameCount * 0.06) * 8 : 55 + sg * 100;
  const og=ctx.createRadialGradient(player.x,player.y,0,player.x,player.y,glowR);
  if(lm){
    og.addColorStop(0,`hsla(${rainbowHue},100%,65%,${0.15+sg})`);
    og.addColorStop(0.4,`hsla(${(rainbowHue+60)%360},100%,60%,0.04)`);
    og.addColorStop(1,'rgba(0,0,0,0)');
  } else {
    og.addColorStop(0,`rgba(${pcr},${0.1+sg})`);og.addColorStop(0.5,`rgba(${pcr},${0.02+sg*0.3})`);og.addColorStop(1,`rgba(${pcr},0)`);
  }
  ctx.fillStyle=og;ctx.beginPath();ctx.arc(player.x,player.y,glowR,0,Math.PI*2);ctx.fill();

  // body
  ctx.beginPath();ctx.arc(player.x,player.y,pr,0,Math.PI*2);
  if(lm){
    const bg=ctx.createRadialGradient(player.x-2,player.y-2,0,player.x,player.y,pr);
    bg.addColorStop(0,`hsl(${rainbowHue},80%,75%)`);bg.addColorStop(1,`hsl(${rainbowHue},90%,55%)`);
    ctx.fillStyle=bg;
  } else {
    const bg=ctx.createRadialGradient(player.x-2,player.y-2,0,player.x,player.y,pr);
    bg.addColorStop(0,'#ccffee');bg.addColorStop(1,'#78FFB4');
    ctx.fillStyle=bg;
  }
  ctx.fill();

  // outer ring
  ctx.beginPath();ctx.arc(player.x,player.y,pr+2.5,0,Math.PI*2);
  if(lm){
    ctx.strokeStyle=`hsla(${(rainbowHue+120)%360},100%,70%,0.4)`;ctx.lineWidth=1.5;
  } else {
    ctx.strokeStyle=nearMissTimer>0?`rgba(255,255,255,${0.4+nearMissTimer/18*0.4})`:`rgba(${pcr},${0.15+sg})`;
    ctx.lineWidth=nearMissTimer>0?1.8:0.8;
  }
  ctx.stroke();

  // $ symbol
  ctx.fillStyle=lm?'#fff':'#000';ctx.font=`bold ${Math.round(pr*0.85)}px Mono, monospace`;
  ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('$',player.x,player.y+0.5);

  // legend mode: rainbow particle trail drip
  if(lm&&frameCount%3===0){
    const rh=(frameCount*4)%360;
    particles.push({x:player.x+(Math.random()-0.5)*6,y:player.y+(Math.random()-0.5)*6,vx:(Math.random()-0.5)*1.5,vy:0.5+Math.random(),life:1,color:`hsl(${rh},100%,65%)`,size:1.5+Math.random()*2});
  }

  // obstacles
  obstacles.forEach(ob=>{
    if(ob.hit)return;const a=ob.stealth?ob.opacity:1;if(a<0.02)return;
    ctx.save();ctx.globalAlpha=a;ctx.translate(ob.x+ob.w/2,ob.y+ob.h/2);ctx.rotate(ob.angle);
    ctx.shadowColor=ob.color;ctx.shadowBlur=4;
    ctx.fillStyle=ob.color+'10';ctx.strokeStyle=ob.color+(ob.nearMissed?'aa':'44');ctx.lineWidth=0.8;
    ctx.beginPath();rr(ctx,-ob.w/2,-ob.h/2,ob.w,ob.h,3);ctx.fill();ctx.stroke();ctx.shadowBlur=0;
    ctx.fillStyle=ob.color;ctx.font=`bold ${W<500?8:10}px Mono, monospace`;
    ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(ob.label,0,0);ctx.restore();
  });

  // particles
  particles.forEach(p=>{ctx.globalAlpha=p.life;if(p.spark){ctx.fillStyle='#fff';ctx.fillRect(p.x,p.y,p.size*p.life,0.8);}else{ctx.fillStyle=p.color;ctx.beginPath();ctx.arc(p.x,p.y,p.size*p.life,0,Math.PI*2);ctx.fill();}ctx.globalAlpha=1;});

  // near miss
  if(nearMissTimer>0){ctx.fillStyle=`rgba(${pcr},${nearMissTimer/18*0.4})`;ctx.font='bold 10px Mono, monospace';ctx.textAlign='center';ctx.fillText('CLOSE',player.x,player.y-24);}

  // HUD
  if(gameState==='playing'||gameState==='dead'){
    const bc=balColor(balance);
    ctx.fillStyle='#383838';ctx.font='8px Mono, monospace';ctx.textAlign='left';ctx.fillText('BALANCE',16,24);
    ctx.fillStyle=bc;ctx.font='bold 22px Mono, monospace';ctx.fillText('$'+balance.toFixed(2),16,46);
    ctx.fillStyle='#111';ctx.fillRect(16,54,100,2);ctx.fillStyle=bc;ctx.fillRect(16,54,100*(balance/100),2);

    ctx.fillStyle='#383838';ctx.font='8px Mono, monospace';ctx.textAlign='right';ctx.fillText('YEARS',W-16,24);
    ctx.fillStyle='#fff';ctx.font='bold 22px Mono, monospace';ctx.fillText(getYears(),W-16,46);
    if(bestYears>0){ctx.fillStyle='#282828';ctx.font='8px Mono, monospace';ctx.fillText('BEST '+bestYears.toFixed(1),W-16,60);}

    ctx.fillStyle='#282828';ctx.font='8px Mono, monospace';ctx.textAlign='center';ctx.fillText('FEES',W/2,24);
    ctx.fillStyle='#ff4444';ctx.font='bold 16px Mono, monospace';ctx.fillText('-$'+totalFeesHit.toFixed(2),W/2,44);

    if(dodgedCount>0){ctx.fillStyle='#1e2e24';ctx.font='8px Mono, monospace';ctx.fillText('DODGED',W/2,58);ctx.fillStyle='#4a8a6a';ctx.font='bold 11px Mono, monospace';ctx.fillText(String(dodgedCount),W/2,72);}
    if(dodgeStreak>=5){ctx.fillStyle=`rgba(${pcr},${0.3+Math.sin(frameCount*0.1)*0.15})`;ctx.font='bold 10px Mono, monospace';ctx.textAlign='center';ctx.fillText('STREAK '+dodgeStreak,W/2,H-20);}
  }
  ctx.restore();
}

// ---- CHALLENGE ----
const urlP=new URLSearchParams(window.location.search);
const cScore=urlP.get('challenge'),cBy=urlP.get('by')||'???';
if(cScore){const i=document.getElementById('challenge-intro');i.style.display='block';i.innerHTML=`<div class="challenger">${cBy} survived</div><div class="challenge-score">${cScore} years</div><div class="challenge-dare">Can you beat it?</div>`;document.getElementById('start-prompt').textContent='TAP TO ACCEPT';}

let handle=localStorage.getItem('fd_handle')||'';
function ensureH(){if(handle)return handle;const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';handle='';for(let i=0;i<3;i++)handle+=c[Math.floor(Math.random()*c.length)];localStorage.setItem('fd_handle',handle);return handle;}
function challengeUrl(){return`${window.location.origin}${window.location.pathname}?challenge=${getYears()}&by=${ensureH()}`;}

function renderShareCard(){
  const c=document.getElementById('share-card'),cx=c.getContext('2d');
  const w=600,h=315;c.width=w;c.height=h;
  const bg=cx.createLinearGradient(0,0,0,h);bg.addColorStop(0,'#050505');bg.addColorStop(1,'#0a0a0a');
  cx.fillStyle=bg;cx.fillRect(0,0,w,h);
  cx.strokeStyle='rgba(120,255,180,0.02)';cx.lineWidth=0.5;
  for(let x=0;x<w;x+=25){cx.beginPath();cx.moveTo(x,0);cx.lineTo(x,h);cx.stroke();}
  for(let y=0;y<h;y+=25){cx.beginPath();cx.moveTo(0,y);cx.lineTo(w,y);cx.stroke();}
  const gl=cx.createRadialGradient(w/2,h*0.4,0,w/2,h*0.4,220);gl.addColorStop(0,'rgba(120,255,180,0.04)');gl.addColorStop(1,'rgba(0,0,0,0)');cx.fillStyle=gl;cx.fillRect(0,0,w,h);
  cx.fillStyle='#383838';cx.font='9px Mono, monospace';cx.textAlign='center';cx.fillText('F E E   D O D G E',w/2,32);
  cx.fillStyle='#fff';cx.font='300 58px Knapp, sans-serif';cx.fillText(getYears(),w/2,100);
  cx.fillStyle='#444';cx.font='10px Mono, monospace';cx.fillText('YEARS SURVIVED',w/2,122);
  cx.fillStyle='#ff4444';cx.font='bold 24px Mono, monospace';cx.fillText('-$'+totalFeesHit.toFixed(2),w*0.3,170);
  cx.fillStyle='#78FFB4';cx.fillText(dodgedCount+' dodged',w*0.7,170);
  cx.fillStyle='#2a2a2a';cx.font='8px Mono, monospace';cx.fillText('FEES TAKEN',w*0.3,185);cx.fillText('FEES DODGED',w*0.7,185);
  const sorted=Object.entries(feesHitMap).sort((a,b)=>b[1]-a[1]);
  if(sorted.length){cx.fillStyle='#2a2a2a';cx.font='9px Mono, monospace';cx.fillText('Killed by: '+sorted[0][0],w/2,215);}
  cx.fillStyle='#78FFB4';cx.font='500 13px Mono, monospace';cx.fillText(ensureH()+' challenges you to beat '+getYears()+' years',w/2,255);
  cx.fillStyle='#222';cx.font='8px Mono, monospace';cx.fillText('LEGEND  \u00B7  FEE DODGE',w/2,290);
  cx.fillStyle='#ff4444';cx.fillRect(0,0,w,1.5);cx.fillStyle='#78FFB4';cx.fillRect(0,h-1.5,w,1.5);
}

function showShareCard(){renderShareCard();document.getElementById('share-card-wrap').classList.add('visible');}
document.getElementById('challenge-btn').addEventListener('click',showShareCard);
document.getElementById('share-copy-btn').addEventListener('click',()=>{navigator.clipboard.writeText(challengeUrl()).then(()=>{const t=document.getElementById('share-toast');t.textContent='Challenge link copied!';t.classList.add('visible');setTimeout(()=>t.classList.remove('visible'),2200);}).catch(()=>prompt('Copy this:',challengeUrl()));});
document.getElementById('share-save-btn').addEventListener('click',()=>{const a=document.createElement('a');a.download='fee-dodge-'+getYears()+'yrs.png';a.href=document.getElementById('share-card').toDataURL('image/png');a.click();});
document.getElementById('share-close-btn').addEventListener('click',()=>{document.getElementById('share-card-wrap').classList.remove('visible');});

function showVictory(){
  const inner = document.querySelector('.death-inner');
  inner.classList.add('victory');
  document.getElementById('ds-years').textContent = getYears();
  document.getElementById('ds-total').textContent = '$' + legendFeesValue.toFixed(2);
  document.querySelector('.death-inner .label-tag').textContent = 'Legend Mode Complete';
  document.querySelector('.death-inner .big-stat').innerHTML = 'You avoided <em>$' + legendFeesValue.toFixed(2) + '</em> in fees';
  document.querySelector('.death-inner .sub-stat').innerHTML = 'Smashed <em>' + legendFeesSmashed + '</em> fees in ' + getYears() + ' years';
  document.getElementById('ds-fees').innerHTML = '';
  document.getElementById('ds-editorial').innerHTML = 'With Legend, fees don\'t touch you. That\'s not a game — that\'s how it actually works.';
  inner.querySelectorAll(':scope > *').forEach((el,i)=>{el.style.animation='none';el.offsetHeight;el.style.animation=`fsi 0.5s ease-out ${i*0.08}s forwards`;});
  setTimeout(()=>document.getElementById('death-screen').classList.add('visible'),400);
}

function showDeath(){
  const y=parseFloat(getYears());if(y>bestYears){bestYears=y;localStorage.setItem('fd_best',String(bestYears));}
  document.getElementById('ds-years').textContent=getYears();
  document.getElementById('ds-total').textContent='$'+totalFeesHit.toFixed(2);
  const feesEl=document.getElementById('ds-fees');
  const sorted=Object.entries(feesHitMap).sort((a,b)=>b[1]-a[1]);
  feesEl.innerHTML=sorted.slice(0,5).map(([l,v])=>`<span>-$${v.toFixed(2)}</span> ${l}`).join('<br>');
  const ed=document.getElementById('ds-editorial');
  if(cScore&&y>parseFloat(cScore)){ed.innerHTML=`<span style="color:#78FFB4">You beat ${cBy}'s ${cScore} years!</span><br>The average American pays $138,000+ in banking fees over a lifetime. On Legend: $0.`;}
  else if(cScore){ed.innerHTML=`${cBy} still leads with ${cScore} years.<br>The average American pays $138,000+ in banking fees over a lifetime. On Legend: $0.`;}
  document.querySelectorAll('.death-inner > *').forEach((el,i)=>{el.style.animation='none';el.offsetHeight;el.style.animation=`fsi 0.5s ease-out ${i*0.08}s forwards`;});
  setTimeout(()=>document.getElementById('death-screen').classList.add('visible'),500);
}

function loop(){update();draw();requestAnimationFrame(loop);}loop();

// ---- LEADERBOARD ----
(function() {
  const DUMMY_DATA = [
    { rank: 1, handle: 'ZKR', years: 31.4, dodged: 847, badge: 'legend' },
    { rank: 2, handle: 'VTL', years: 28.9, dodged: 762, badge: 'legend' },
    { rank: 3, handle: 'MXN', years: 27.1, dodged: 701, badge: 'x' },
    { rank: 4, handle: 'DFI', years: 24.8, dodged: 655, badge: 'legend' },
    { rank: 5, handle: 'APX', years: 23.2, dodged: 612, badge: 'x' },
    { rank: 6, handle: 'NRG', years: 21.7, dodged: 580, badge: null },
    { rank: 7, handle: 'KYC', years: 19.3, dodged: 511, badge: 'legend' },
    { rank: 8, handle: 'BLK', years: 18.1, dodged: 478, badge: null },
    { rank: 9, handle: 'FEN', years: 16.5, dodged: 433, badge: 'x' },
    { rank: 10, handle: 'RWA', years: 15.2, dodged: 398, badge: null },
  ];

  const legendBadgeSVG = '<svg viewBox="0 0 40 40" fill="none"><path d="M19.969 40C26.47 40 32.217 36.952 35.864 32.175C35.99 32.009 36.054 31.926 36.081 31.826C36.103 31.741 36.103 31.639 36.081 31.554C36.054 31.454 35.991 31.371 35.864 31.205C32.217 26.426 26.471 23.349 20 23.349C13.529 23.349 7.783 26.426 4.136 31.205C4.009 31.371 3.946 31.454 3.919 31.554C3.897 31.639 3.897 31.741 3.919 31.826C3.946 31.926 4.009 32.009 4.136 32.175C7.783 36.952 13.528 40 19.969 40ZM19.969 0C8.947 0 0 8.961 0 20C0 23.533 0.906 26.819 2.511 29.702C2.609 29.877 2.658 29.965 2.729 30.001C2.79 30.032 2.865 30.038 2.93 30.017C3.006 29.992 3.069 29.912 3.196 29.75L19.338 9.185C19.564 8.897 19.677 8.753 19.814 8.701C19.934 8.656 20.066 8.656 20.186 8.701C20.324 8.753 20.437 8.897 20.662 9.185L36.804 29.75C36.931 29.912 36.994 29.992 37.07 30.017C37.136 30.038 37.21 30.032 37.271 30.001C37.343 29.965 37.391 29.877 37.489 29.702C39.094 26.819 40 23.533 40 20C40 8.961 31.053 0 19.969 0Z" fill="#78FFB4"/></svg>';
  const xBadgeSVG = '<svg viewBox="0 0 24 24" fill="none"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z" fill="#888"/></svg>';

  const table = document.getElementById('lb-table');
  const myHandle = localStorage.getItem('fd_handle') || '';

  function render() {
    table.innerHTML = DUMMY_DATA.map(d => {
      const isYou = d.handle === myHandle;
      const top3 = d.rank <= 3;
      let badgeHtml = '';
      if (d.badge === 'legend') badgeHtml = `<span class="lb-badge legend-badge">${legendBadgeSVG}</span>`;
      else if (d.badge === 'x') badgeHtml = `<span class="lb-badge x-badge">${xBadgeSVG}</span>`;
      return `<div class="lb-row${isYou ? ' you' : ''}${top3 ? ' top3' : ''}">
        <div class="lb-rank">${d.rank}</div>
        <div class="lb-player">
          <span class="lb-handle">${d.handle}</span>
          ${badgeHtml}
          ${isYou ? '<span class="lb-you-tag">You</span>' : ''}
        </div>
        <div class="lb-score">${d.years.toFixed(1)}<span class="unit">yr</span></div>
      </div>`;
    }).join('');
  }

  render();
  document.getElementById('lb-close-btn').addEventListener('click', () => {
    document.getElementById('leaderboard').classList.remove('visible');
  });
})();
</script>
</body>
</html>
